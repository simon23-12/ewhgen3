
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erwartungshorizont Generator - Englisch & Philosophie</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2332 50%, #0d1b2a 100%);
            min-height: 100vh;
            padding: 30px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
        }

        .header-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 20px rgba(0,0,0,0.2);
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.15em;
            font-weight: 400;
            opacity: 0.95;
            text-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }

        .success-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }

        /* Subject Tabs */
        .subject-tab {
            padding: 12px 32px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .subject-tab:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.1);
        }

        .subject-tab.active {
            background: white;
            color: #0a1929;
            font-weight: 600;
        }

        .subject-content {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Glassmorphic card styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            padding: 30px;
        }

        .glass-card-strong {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            padding: 30px;
        }

        .info-box {
            background: rgba(255, 243, 205, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-left: 4px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: white;
        }

        .info-box h3 {
            font-size: 1.15em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
            line-height: 1.7;
        }

        .info-box li {
            margin: 6px 0;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: white;
            font-size: 1.05em;
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .glass-card-strong label {
            color: #333;
            text-shadow: none;
        }

        textarea {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            resize: vertical;
            color: #333;
        }

        textarea::placeholder {
            color: #999;
        }

        textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }

        .button-container {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 16px 24px;
            font-size: 1.05em;
            font-weight: 600;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .clear-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }

        .output {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 25px;
            min-height: 200px;
            color: #333;
        }

        .output.empty {
            color: #999;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .download-btn {
            background: #4CAF50;
            color: white;
            margin-top: 15px;
            flex: 1;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .download-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .btn-docx {
            background: linear-gradient(135deg, #2b579a 0%, #1e3f6e 100%);
            box-shadow: 0 4px 15px rgba(43, 87, 154, 0.3);
        }

        .btn-docx:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(43, 87, 154, 0.4);
        }

        .btn-odt {
            background: linear-gradient(135deg, #0369a1 0%, #075985 100%);
            box-shadow: 0 4px 15px rgba(3, 105, 161, 0.3);
        }

        .btn-odt:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(3, 105, 161, 0.4);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .btn-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .hidden {
            display: none;
        }

        /* Sidebar PDF Section */
        .sidebar {
            position: sticky;
            top: 30px;
        }

        .sidebar-header {
            color: white;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pdf-item {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pdf-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .pdf-item-content {
            flex: 1;
        }

        .pdf-item-title {
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            font-size: 0.95em;
            line-height: 1.3;
        }

        .pdf-item-desc {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.85em;
        }

        /* Preview table styles */
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            font-family: 'Inter', sans-serif;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .preview-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .preview-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .preview-section {
            margin: 30px 0;
        }

        .preview-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
        }

        .preview-subtitle {
            font-size: 1.05em;
            font-weight: 600;
            color: #667eea;
            margin: 15px 0 10px 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            margin: 2% auto;
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.8em;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-weight: 300;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1) rotate(90deg);
        }

        .pdf-viewer {
            width: 100%;
            height: calc(100% - 80px);
            border: none;
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-section:last-of-type {
            margin-bottom: 0;
        }

        .output-section {
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .glass-card, .glass-card-strong {
                padding: 20px;
            }

            .button-container {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }

        /* Print styles for PDF export */
        @media print {
            /* Hide everything except the output */
            body {
                background: white !important;
            }

            .header,
            .glass-card:not(.output-section),
            .sidebar,
            .download-buttons,
            button {
                display: none !important;
            }

            .main-grid {
                display: block !important;
            }

            .glass-card-strong.output-section {
                background: white !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .glass-card-strong.output-section label {
                display: none !important;
            }

            #output {
                background: white !important;
                border: none !important;
                padding: 20px !important;
                margin: 0 !important;
            }

            /* Ensure tables print correctly */
            .preview-table {
                page-break-inside: avoid;
                border-collapse: collapse !important;
                border: 1px solid #000 !important;
            }

            .preview-table th,
            .preview-table td {
                border: 1px solid #000 !important;
                padding: 8px !important;
            }

            .preview-table thead th {
                background-color: #f0f0f0 !important;
                font-weight: bold !important;
            }

            .preview-section {
                page-break-inside: avoid;
            }

            /* Remove contenteditable styling for print */
            [contenteditable="true"] {
                border: 1px solid #000 !important;
                outline: none !important;
            }

            .preview-table [contenteditable="true"] {
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="images/schoollogoonly.png" alt="School Logo" class="header-logo">
                <h1>Erwartungshorizont Generator</h1>
            </div>
            <p>fÃ¼r Klausuren Sek II NRW</p>
        </div>

        <!-- Subject Tabs -->
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="display: inline-flex; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border-radius: 16px; padding: 6px; border: 1px solid rgba(255, 255, 255, 0.3);">
                <button id="tabEnglisch" class="subject-tab active" onclick="switchSubject('englisch')">Englisch</button>
                <button id="tabPhilosophie" class="subject-tab" onclick="switchSubject('philosophie')">Philosophie</button>
            </div>
        </div>

        <!-- Englisch Content -->
        <div id="contentEnglisch" class="subject-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div class="glass-card">
                        <div class="info-box">
                            <h3>So funktioniert's:</h3>
                        <ul>
                            <li>Einfach Klausur als PDF hochladen oder Texte und Aufgaben manuell einfÃ¼gen</li>
                            <li>Bei manuellem EinfÃ¼gen: Bitte mit Author, Quelle etc.</li>
                            <li>Erhalte einen strukturierten Erwartungshorizont nach NRW-Kriterien</li>
                            <li>Bearbeite ihn direkt im Browser und lade ihn als PDF herunter</li>
                            <li>Lade Simon als Dank mal irgendwann auf einen Kaffee ein</li>
                        </ul>
                    </div>

                    <div class="input-section" style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 25px;">
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 12px; margin-bottom: 0;">
                            <input type="checkbox" id="listeningMode" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-size: 1.05em;">Listening Comprehension inkludieren</span>
                        </label>
                    </div>

                    <div class="input-section" style="background: rgba(102, 126, 234, 0.15); border: 2px dashed rgba(102, 126, 234, 0.5); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <label style="font-size: 1.05em; font-weight: 600; margin-bottom: 12px; display: block;">
                            ðŸ“„ Klausur-PDF hochladen (Optional)
                        </label>
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 15px;">
                            Lade eine PDF-Datei mit den Klausurtexten und Aufgaben hoch oder ziehe sie per Drag & Drop hierher
                        </p>
                        <div id="pdfDropZone" style="background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.4); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px;">
                            <div style="font-size: 3em; margin-bottom: 10px;">ðŸ“„</div>
                            <p style="color: white; font-weight: 500; margin-bottom: 5px;">PDF hier ablegen</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em;">oder klicken zum AuswÃ¤hlen</p>
                        </div>
                        <input type="file" id="pdfUpload" accept=".pdf" style="display: none;">
                        <button type="button" onclick="document.getElementById('pdfUpload').click()" style="width: 100%; padding: 12px; background: rgba(102, 126, 234, 0.3); border: 1px solid rgba(102, 126, 234, 0.6); border-radius: 8px; color: white; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px;">
                            ðŸ“Ž Datei auswÃ¤hlen
                        </button>
                        <p id="pdfStatus" style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-top: 10px; display: none;"></p>
                    </div>

                    <div class="input-section">
                        <label for="inputText">Teil A: Aufgabentext (Englisch)</label>
                        <textarea
                            id="inputText"
                            rows="10"
                            placeholder="FÃ¼ge hier den englischen Text fÃ¼r Comprehension/Analysis ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="task2Text">Teil A - Aufgabe 2 (Analysis)</label>
                       
                        <textarea
                            id="task2Text"
                            rows="3"
                            placeholder="Optional: Aufgabenstellung fÃ¼r die Analyse (z.B. 'Analyse the atmosphere in the extract...')..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="task3aText">Teil A - Aufgabe 3a (z.B. Discussion/Evaluation)</label>
                        <textarea
                            id="task3aText"
                            rows="4"
                            placeholder="FÃ¼ge hier die Aufgabenstellung fÃ¼r Aufgabe 3a ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="task3bText">Teil A - Aufgabe 3b (z.B. Re-creation/Letter) - Optional</label>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: -8px; margin-bottom: 10px;">
                            Wenn freigelassen, wird nur Aufgabe 3a erstellt
                        </p>
                        <textarea
                            id="task3bText"
                            rows="4"
                            placeholder="FÃ¼ge hier die Aufgabenstellung fÃ¼r Aufgabe 3b ein (optional)..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="mediationText">Teil B: Mediation Text (Deutsch)</label>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: -8px; margin-bottom: 10px;">
                            FÃ¼r Klausur ohne Mediation (EF) einfach freilassen
                        </p>
                        <textarea
                            id="mediationText"
                            rows="6"
                            placeholder="FÃ¼ge hier den deutschen Text fÃ¼r Mediation ein..."
                        ></textarea>
                    </div>

                    <div class="button-container">
                        <button class="generate-btn" onclick="generateErwartungshorizont()">
                            Erwartungshorizont erstellen
                        </button>
                        <button class="clear-btn" onclick="clearAll()">
                            Alles lÃ¶schen
                        </button>
                    </div>
                </div>

                <div class="glass-card-strong output-section">
                    <label>Generierter Erwartungshorizont:</label>
                    <div id="output" class="output empty">
                        Hier erscheint dein Erwartungshorizont...
                    </div>
                    <div class="download-buttons hidden" id="downloadButtons">
                        <button class="download-btn btn-pdf" onclick="printAsPdf()">
                            Als PDF speichern
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Englisch Content -->

        <!-- Philosophie Content -->
        <div id="contentPhilosophie" class="subject-content" style="display: none;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div class="glass-card">
                        <div class="info-box">
                            <h3>So funktioniert's:</h3>
                            <ul>
                                <li>Einfach Klausur als PDF hochladen oder Texte und Aufgaben manuell einfÃ¼gen</li>
                                <li>Der Generator erkennt automatisch, ob es sich um TexterschlieÃŸung oder ProblemerÃ¶rterung handelt</li>
                                <li>Erhalte einen strukturierten Erwartungshorizont nach NRW-Kriterien</li>
                                <li>Bearbeite ihn direkt im Browser und lade ihn als PDF herunter</li>
                                <li>Lade Simon als Dank mal irgendwann auf einen Kaffee ein</li>
                            </ul>
                        </div>

                        <div class="input-section" style="background: rgba(102, 126, 234, 0.15); border: 2px dashed rgba(102, 126, 234, 0.5); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                            <label style="font-size: 1.05em; font-weight: 600; margin-bottom: 12px; display: block;">
                                ðŸ“„ Klausur-PDF hochladen (Optional)
                            </label>
                            <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 15px;">
                                Lade eine PDF-Datei mit dem Klausurtext und Aufgaben hoch oder ziehe sie per Drag & Drop hierher
                            </p>
                            <div id="pdfDropZonePhilo" style="background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.4); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px;">
                                <div style="font-size: 3em; margin-bottom: 10px;">ðŸ“„</div>
                                <p style="color: white; font-weight: 500; margin-bottom: 5px;">PDF hier ablegen</p>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.9em;">oder klicken zum AuswÃ¤hlen</p>
                            </div>
                            <input type="file" id="pdfUploadPhilo" accept=".pdf" style="display: none;">
                            <button type="button" onclick="document.getElementById('pdfUploadPhilo').click()" style="width: 100%; padding: 12px; background: rgba(102, 126, 234, 0.3); border: 1px solid rgba(102, 126, 234, 0.6); border-radius: 8px; color: white; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px;">
                                ðŸ“Ž Datei auswÃ¤hlen
                            </button>
                            <p id="pdfStatusPhilo" style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-top: 10px; display: none;"></p>
                        </div>

                        <div class="input-section">
                            <label for="philoPrimaryText">Klausurtext (PrimÃ¤rtext / Zitat)</label>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: -8px; margin-bottom: 10px;">
                                Bei TexterschlieÃŸung: Der philosophische Text. Bei ProblemerÃ¶rterung: Das Zitat oder Dilemma.
                            </p>
                            <textarea
                                id="philoPrimaryText"
                                rows="12"
                                placeholder="FÃ¼ge hier den philosophischen PrimÃ¤rtext oder das Zitat ein..."
                            ></textarea>
                        </div>

                        <div class="input-section">
                            <label for="philoTask1">Aufgabe 1</label>
                            <textarea
                                id="philoTask1"
                                rows="4"
                                placeholder="FÃ¼ge hier die Aufgabenstellung fÃ¼r Aufgabe 1 ein..."
                            ></textarea>
                        </div>

                        <div class="input-section">
                            <label for="philoTask2">Aufgabe 2</label>
                            <textarea
                                id="philoTask2"
                                rows="4"
                                placeholder="FÃ¼ge hier die Aufgabenstellung fÃ¼r Aufgabe 2 ein..."
                            ></textarea>
                        </div>

                        <div class="input-section">
                            <label for="philoTask3">Aufgabe 3</label>
                            <textarea
                                id="philoTask3"
                                rows="4"
                                placeholder="FÃ¼ge hier die Aufgabenstellung fÃ¼r Aufgabe 3 ein..."
                            ></textarea>
                        </div>

                        <div class="button-container">
                            <button class="generate-btn" onclick="generateErwartungshorizontPhilo()">
                                Erwartungshorizont erstellen
                            </button>
                            <button class="clear-btn" onclick="clearAllPhilo()">
                                Alles lÃ¶schen
                            </button>
                        </div>
                    </div>

                    <div class="glass-card-strong output-section">
                        <label>Generierter Erwartungshorizont:</label>
                        <div id="outputPhilo" class="output empty">
                            Hier erscheint dein Erwartungshorizont...
                        </div>
                        <div class="download-buttons hidden" id="downloadButtonsPhilo">
                            <button class="download-btn btn-pdf" onclick="printAsPdfPhilo()">
                                Als PDF speichern
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Philosophie Content -->
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pdfTitle">PDF Dokument</h2>
                <button class="modal-close" onclick="closePDF()">&times;</button>
            </div>
            <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        </div>
    </div>

    <script>
        let currentContentData = null;
        let currentListeningMode = false;

        // PDF Upload Handler with Drag & Drop
        document.addEventListener('DOMContentLoaded', function() {
            // Englisch PDF handlers
            const pdfUpload = document.getElementById('pdfUpload');
            const pdfDropZone = document.getElementById('pdfDropZone');

            if (pdfUpload) {
                pdfUpload.addEventListener('change', handlePDFUpload);
            }

            if (pdfDropZone) {
                // Click to upload
                pdfDropZone.addEventListener('click', () => {
                    pdfUpload.click();
                });

                // Drag and drop
                pdfDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    pdfDropZone.style.background = 'rgba(102, 126, 234, 0.3)';
                    pdfDropZone.style.borderColor = 'rgba(102, 126, 234, 0.8)';
                });

                pdfDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    pdfDropZone.style.background = 'rgba(255,255,255,0.1)';
                    pdfDropZone.style.borderColor = 'rgba(255,255,255,0.4)';
                });

                pdfDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pdfDropZone.style.background = 'rgba(255,255,255,0.1)';
                    pdfDropZone.style.borderColor = 'rgba(255,255,255,0.4)';

                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/pdf') {
                        // Trigger handlePDFUpload with the dropped file
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(files[0]);
                        pdfUpload.files = dataTransfer.files;
                        handlePDFUpload({ target: { files: files } });
                    } else {
                        const statusEl = document.getElementById('pdfStatus');
                        statusEl.style.display = 'block';
                        statusEl.textContent = 'âœ— Bitte nur PDF-Dateien hochladen';
                        statusEl.style.color = 'rgba(244, 67, 54, 1)';
                    }
                });
            }

            // Philosophie PDF handlers
            const pdfUploadPhilo = document.getElementById('pdfUploadPhilo');
            const pdfDropZonePhilo = document.getElementById('pdfDropZonePhilo');

            if (pdfUploadPhilo) {
                pdfUploadPhilo.addEventListener('change', handlePDFUploadPhilo);
            }

            if (pdfDropZonePhilo) {
                // Click to upload
                pdfDropZonePhilo.addEventListener('click', () => {
                    pdfUploadPhilo.click();
                });

                // Drag and drop
                pdfDropZonePhilo.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    pdfDropZonePhilo.style.background = 'rgba(102, 126, 234, 0.3)';
                    pdfDropZonePhilo.style.borderColor = 'rgba(102, 126, 234, 0.8)';
                });

                pdfDropZonePhilo.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    pdfDropZonePhilo.style.background = 'rgba(255,255,255,0.1)';
                    pdfDropZonePhilo.style.borderColor = 'rgba(255,255,255,0.4)';
                });

                pdfDropZonePhilo.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pdfDropZonePhilo.style.background = 'rgba(255,255,255,0.1)';
                    pdfDropZonePhilo.style.borderColor = 'rgba(255,255,255,0.4)';

                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/pdf') {
                        // Trigger handlePDFUploadPhilo with the dropped file
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(files[0]);
                        pdfUploadPhilo.files = dataTransfer.files;
                        handlePDFUploadPhilo({ target: { files: files } });
                    } else {
                        const statusEl = document.getElementById('pdfStatusPhilo');
                        statusEl.style.display = 'block';
                        statusEl.textContent = 'âœ— Bitte nur PDF-Dateien hochladen';
                        statusEl.style.color = 'rgba(244, 67, 54, 1)';
                    }
                });
            }
        });

        async function handlePDFUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('pdfStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = 'PDF wird verarbeitet...';
            statusEl.style.color = 'rgba(102, 126, 234, 1)';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }

                statusEl.textContent = 'Text wird analysiert und verteilt, bitte warten...';

                // Use AI to intelligently distribute text to fields
                await distributePDFText(fullText.trim(), statusEl);

            } catch (error) {
                console.error('PDF Error:', error);
                statusEl.textContent = 'âœ— Fehler beim Laden der PDF: ' + error.message;
                statusEl.style.color = 'rgba(244, 67, 54, 1)';
            }
        }

        async function distributePDFText(fullText, statusEl) {
            try {
                const response = await fetch('/api/parse-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pdfText: fullText })
                });

                if (!response.ok) {
                    throw new Error('Fehler bei der Text-Analyse');
                }

                const data = await response.json();

                if (data.success) {
                    // Fill fields with distributed text
                    if (data.data.inputText) {
                        document.getElementById('inputText').value = data.data.inputText;
                    }
                    if (data.data.task2Text) {
                        document.getElementById('task2Text').value = data.data.task2Text;
                    }
                    if (data.data.task3aText) {
                        document.getElementById('task3aText').value = data.data.task3aText;
                    }
                    if (data.data.task3bText) {
                        document.getElementById('task3bText').value = data.data.task3bText;
                    }
                    if (data.data.mediationText) {
                        document.getElementById('mediationText').value = data.data.mediationText;
                    }

                    statusEl.textContent = 'âœ“ PDF erfolgreich geladen und Texte verteilt';
                    statusEl.style.color = 'rgba(76, 175, 80, 1)';
                } else {
                    throw new Error(data.error || 'Fehler bei der Verteilung');
                }

            } catch (error) {
                console.error('Distribution Error:', error);
                // Fallback: just put everything in inputText
                document.getElementById('inputText').value = fullText;
                statusEl.textContent = 'âš  PDF geladen, aber automatische Verteilung fehlgeschlagen. Bitte manuell aufteilen.';
                statusEl.style.color = 'rgba(255, 152, 0, 1)';
            }
        }

        // Philosophie PDF Upload Handler
        async function handlePDFUploadPhilo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('pdfStatusPhilo');
            statusEl.style.display = 'block';
            statusEl.textContent = 'PDF wird verarbeitet...';
            statusEl.style.color = 'rgba(102, 126, 234, 1)';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }

                statusEl.textContent = 'Text wird analysiert und verteilt, bitte warten...';

                // Use AI to intelligently distribute text to fields
                await distributePDFTextPhilo(fullText.trim(), statusEl);

            } catch (error) {
                console.error('PDF Error:', error);
                statusEl.textContent = 'âœ— Fehler beim Laden der PDF: ' + error.message;
                statusEl.style.color = 'rgba(244, 67, 54, 1)';
            }
        }

        async function distributePDFTextPhilo(fullText, statusEl) {
            try {
                const response = await fetch('/api/parse-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pdfText: fullText,
                        subject: 'philosophie'
                    })
                });

                if (!response.ok) {
                    throw new Error('Fehler bei der Text-Analyse');
                }

                const data = await response.json();

                if (data.success) {
                    // Fill Philosophie fields with distributed text
                    if (data.data.primaryText) {
                        document.getElementById('philoPrimaryText').value = data.data.primaryText;
                    }
                    if (data.data.task1) {
                        document.getElementById('philoTask1').value = data.data.task1;
                    }
                    if (data.data.task2) {
                        document.getElementById('philoTask2').value = data.data.task2;
                    }
                    if (data.data.task3) {
                        document.getElementById('philoTask3').value = data.data.task3;
                    }

                    statusEl.textContent = 'âœ“ PDF erfolgreich geladen und Texte verteilt';
                    statusEl.style.color = 'rgba(76, 175, 80, 1)';
                } else {
                    throw new Error(data.error || 'Fehler bei der Verteilung');
                }

            } catch (error) {
                console.error('Distribution Error:', error);
                // Fallback: just put everything in primaryText
                document.getElementById('philoPrimaryText').value = fullText;
                statusEl.textContent = 'âš  PDF geladen, aber automatische Verteilung fehlgeschlagen. Bitte manuell aufteilen.';
                statusEl.style.color = 'rgba(255, 152, 0, 1)';
            }
        }

        // PDF Modal Functions
        function openPDF(pdfPath, title) {
            const modal = document.getElementById('pdfModal');
            const viewer = document.getElementById('pdfViewer');
            const titleElement = document.getElementById('pdfTitle');

            titleElement.textContent = title;
            viewer.src = pdfPath;
            modal.style.display = 'block';

            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closePDF() {
            const modal = document.getElementById('pdfModal');
            const viewer = document.getElementById('pdfViewer');

            modal.style.display = 'none';
            viewer.src = '';

            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('pdfModal');
            if (event.target === modal) {
                closePDF();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePDF();
            }
        });

        async function generateErwartungshorizont() {
            const inputText = document.getElementById('inputText').value.trim();
            const task2Text = document.getElementById('task2Text').value.trim();
            const task3aText = document.getElementById('task3aText').value.trim();
            const task3bText = document.getElementById('task3bText').value.trim();
            const mediationText = document.getElementById('mediationText').value.trim();
            const listeningMode = document.getElementById('listeningMode').checked;
            const outputDiv = document.getElementById('output');
            const generateBtn = document.querySelector('.generate-btn');
            const downloadButtons = document.getElementById('downloadButtons');

            if (!inputText) {
                alert('Bitte gib mindestens einen Text fÃ¼r Teil A ein!');
                return;
            }

            if (!task3aText) {
                alert('Bitte gib mindestens eine Aufgabenstellung fÃ¼r Aufgabe 3a ein!');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generiere mit Google AI...';
            outputDiv.className = 'output loading';
            outputDiv.innerHTML = 'Erwartungshorizont wird erstellt, bitte warten...';
            downloadButtons.classList.add('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'englisch',
                        inputText,
                        task2Text,
                        task3aText,
                        task3bText,
                        mediationText,
                        listeningMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Fehler bei der Generierung');
                }

                currentContentData = data.data;
                currentListeningMode = listeningMode;
                displayErwartungshorizont(currentContentData);
                downloadButtons.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                outputDiv.className = 'output';
                outputDiv.innerHTML = `
                    <p style="color: #d32f2f; font-weight: 600;">Fehler bei der Generierung</p>
                    <p style="color: #666; margin-top: 10px;">${error.message}</p>
                    <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                        MÃ¶gliche Ursachen:<br>
                        - API nicht erreichbar<br>
                        - Google Gemini API-Key fehlt oder ungÃ¼ltig<br>
                        - Netzwerkprobleme<br>
                        - Rate Limit erreicht (15 Anfragen/Minute)
                    </p>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Erwartungshorizont erstellen';
            }
        }

        function displayErwartungshorizont(contentData) {
            const outputDiv = document.getElementById('output');
            outputDiv.className = 'output';
            outputDiv.setAttribute('contenteditable', 'true');
            outputDiv.style.outline = 'none';

            let html = '<h1 contenteditable="true">Bewertungsbogen fÃ¼r: ___________________________</h1>';

            // Add simple Listening Comprehension table if listening mode is active
            if (currentListeningMode) {
                html += `
                    <div class="preview-section">
                        <h3 contenteditable="true">Listening Comprehension</h3>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 70%">Bereich</th>
                                    <th style="width: 15%">Maximum</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td contenteditable="true">Listening Comprehension</td>
                                    <td contenteditable="true">30</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            html += '<h2>Teil A: Inhaltliche Leistung</h2>';

            let teilAInhalt = 0;
            let teilBInhalt = 0;

            // Separate Teil A and Teil B
            const teilATasks = contentData.teilaufgaben.filter(ta => ta.typ !== 'Mediation');
            const teilBTasks = contentData.teilaufgaben.filter(ta => ta.typ === 'Mediation');

            // Check if there are choice tasks (3a and 3b)
            const hasTask3a = teilATasks.some(ta => ta.name.includes('3a'));
            const hasTask3b = teilATasks.some(ta => ta.name.includes('3b'));
            const isChoiceTask = hasTask3a && hasTask3b;

            // Display Teil A tasks
            teilATasks.forEach((teilaufgabe, idx) => {
                html += `
                    <div class="preview-section">
                        <div class="preview-title" contenteditable="true">${teilaufgabe.name}</div>
                        <div class="preview-subtitle" contenteditable="true">Typ: ${teilaufgabe.typ}</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">Nr.</th>
                                    <th style="width: 65%">Anforderung</th>
                                    <th style="width: 15%">Punkte</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                teilaufgabe.kriterien.forEach(kriterium => {
                    html += `
                        <tr>
                            <td contenteditable="true">${kriterium.nr}</td>
                            <td contenteditable="true">${kriterium.text}</td>
                            <td contenteditable="true">${kriterium.punkte}</td>
                            <td contenteditable="true"></td>
                        </tr>
                    `;
                });

                const summe = teilaufgabe.kriterien.reduce((sum, k) => {
                    return sum + (typeof k.punkte === 'number' ? k.punkte : 0);
                }, 0);

                // Only count one of the choice tasks (3a or 3b) in total
                const isTask3b = teilaufgabe.name.includes('3b');
                if (!isChoiceTask || !isTask3b) {
                    teilAInhalt += summe;
                }

                html += `
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="2">Summe ${teilaufgabe.name}</td>
                                <td contenteditable="true">${summe}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            });

            // Detect exam type for language sections
            const isListening = contentData.teilaufgaben.some(ta => ta.name.includes('Teil B') && ta.typ !== 'Mediation');
            const hasMediation = teilBTasks.length > 0;

            // Determine language points for Teil A
            let teilALanguagePoints, teilAKommPoints, teilAAusdrPoints, teilASprachPoints;
            if (isListening) {
                teilALanguagePoints = 72;
                teilAKommPoints = 24;
                teilAAusdrPoints = 24;
                teilASprachPoints = 24;
            } else if (!hasMediation) {
                teilALanguagePoints = 90;
                teilAKommPoints = 30;
                teilAAusdrPoints = 30;
                teilASprachPoints = 30;
            } else {
                teilALanguagePoints = 63;
                teilAKommPoints = 21;
                teilAAusdrPoints = 21;
                teilASprachPoints = 21;
            }

            // Add Teil A language sections to preview
            html += `
                <div class="preview-section">
                    <div class="preview-title">Teil A: Sprachliche Leistung / Darstellungsleistung</div>
                    <div class="preview-subtitle">Kommunikative Textgestaltung</div>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">Nr.</th>
                                <th style="width: 65%">Anforderung</th>
                                <th style="width: 15%">Punkte</th>
                                <th style="width: 15%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">1</td><td contenteditable="true">richtet seinen/ihren Text konsequent und explizit im Sinne der Aufgabenstellung auf die Intention und den/die Adressaten aus.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.286)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">2</td><td contenteditable="true">beachtet die Textsortenmerkmale der jeweils geforderten Zieltextformate.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">3</td><td contenteditable="true">erstellt einen sachgerecht strukturierten leserfreundlichen Text, u.a. durch sprachliche VerknÃ¼pfungen, AbsÃ¤tze als erkennbare Sinnabschnitte.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">4</td><td contenteditable="true">formuliert hinreichend ausfÃ¼hrlich, aber ohne unnÃ¶tige Wiederholungen und UmstÃ¤ndlichkeiten.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">5</td><td contenteditable="true">belegt seine Aussagen durch eine funktionale Verwendung von Verweisen und Zitaten.</td><td contenteditable="true">${Math.floor(teilAKommPoints * 0.143)}</td><td contenteditable="true"></td></tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="2">Summe Kommunikative Textgestaltung</td>
                                <td contenteditable="true">${teilAKommPoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="preview-subtitle">AusdrucksvermÃ¶gen / VerfÃ¼gbarkeit sprachlicher Mittel</div>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">Nr.</th>
                                <th style="width: 65%">Anforderung</th>
                                <th style="width: 15%">Punkte</th>
                                <th style="width: 15%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">1</td><td contenteditable="true">lÃ¶st sich vom Ausgangstext und formuliert eigenstÃ¤ndig.</td><td contenteditable="true">${Math.ceil(teilAAusdrPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">2</td><td contenteditable="true">verwendet einen sachlich wie stilistisch angemessenen und differenzierten allgemeinen und thematischen Wortschatz.</td><td contenteditable="true">${Math.ceil(teilAAusdrPoints * 0.238)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">3</td><td contenteditable="true">verwendet funktional einen sachlich wie stilistisch angemessenen und differenzierten Funktions- und Interpretationswortschatz.</td><td contenteditable="true">${Math.ceil(teilAAusdrPoints * 0.238)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">4</td><td contenteditable="true">verwendet einen variablen und dem jeweiligen Zieltextformat angemessenen Satzbau.</td><td contenteditable="true">${Math.floor(teilAAusdrPoints * 0.333)}</td><td contenteditable="true"></td></tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true" colspan="2">Summe AusdrucksvermÃ¶gen/VerfÃ¼gbarkeit sprachl. Mittel</td>
                                <td contenteditable="true">${teilAAusdrPoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="preview-subtitle">Sprachrichtigkeit</div>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">Nr.</th>
                                <th style="width: 65%">Anforderung</th>
                                <th style="width: 15%">Punkte</th>
                                <th style="width: 15%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">1</td><td contenteditable="true">Wortschatz</td><td contenteditable="true">${Math.ceil(teilASprachPoints * 0.381)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">2</td><td contenteditable="true">Grammatik</td><td contenteditable="true">${Math.ceil(teilASprachPoints * 0.381)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">3</td><td contenteditable="true">Orthographie (Rechtschreibung und Zeichensetzung)</td><td contenteditable="true">${Math.floor(teilASprachPoints * 0.238)}</td><td contenteditable="true"></td></tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true" colspan="2">Summe Sprachrichtigkeit</td>
                                <td contenteditable="true">${teilASprachPoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>

                    <p style="font-weight: bold; margin-top: 20px; font-size: 1.1em; color: #667eea;">
                        Summe Sprache Teil A: ${teilALanguagePoints} Punkte
                    </p>
                    <p style="font-weight: bold; margin-top: 10px; font-size: 1.2em; color: #333;">
                        Gesamtpunktzahl Teil A (Inhalt + Sprache): ${teilAInhalt + teilALanguagePoints} Punkte
                    </p>
                </div>
            `;

            // Add Teil B (Mediation) if present
            if (hasMediation) {
                teilBTasks.forEach((teilaufgabe, idx) => {
                    html += `
                        <div class="preview-section">
                            <div class="preview-title">${teilaufgabe.name}</div>
                            <div class="preview-subtitle">Typ: ${teilaufgabe.typ}</div>
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">Nr.</th>
                                        <th style="width: 65%">Anforderung</th>
                                        <th style="width: 15%">Punkte</th>
                                        <th style="width: 15%">Erreicht</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    teilaufgabe.kriterien.forEach(kriterium => {
                        html += `
                            <tr>
                                <td contenteditable="true">${kriterium.nr}</td>
                                <td contenteditable="true">${kriterium.text}</td>
                                <td contenteditable="true">${kriterium.punkte}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        `;
                    });

                    const summe = teilaufgabe.kriterien.reduce((sum, k) => {
                        return sum + (typeof k.punkte === 'number' ? k.punkte : 0);
                    }, 0);
                    teilBInhalt += summe;

                    html += `
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td contenteditable="true" colspan="2">Summe ${teilaufgabe.name}</td>
                                    <td contenteditable="true">${summe}</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    `;
                });

                // Teil B language sections (27 points total: 9+9+9)
                html += `
                    <div class="preview-section">
                        <div class="preview-title">Teil B: Sprachliche Leistung / Darstellungsleistung</div>
                        <div class="preview-subtitle">Kommunikative Textgestaltung</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">Nr.</th>
                                    <th style="width: 65%">Anforderung</th>
                                    <th style="width: 15%">Punkte</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td contenteditable="true">1</td><td contenteditable="true">richtet seinen/ihren Text konsequent und explizit im Sinne der Aufgabenstellung auf die Intention und den/die Adressaten aus.</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">2</td><td contenteditable="true">beachtet die Textsortenmerkmale der jeweils geforderten Zieltextformate.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">3</td><td contenteditable="true">erstellt einen sachgerecht strukturierten leserfreundlichen Text, u.a. durch sprachliche VerknÃ¼pfungen, AbsÃ¤tze als erkennbare Sinnabschnitte.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">4</td><td contenteditable="true">formuliert hinreichend ausfÃ¼hrlich, aber ohne unnÃ¶tige Wiederholungen und UmstÃ¤ndlichkeiten.</td><td contenteditable="true">1</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">5</td><td contenteditable="true">belegt seine Aussagen durch eine funktionale Verwendung von Verweisen und Zitaten.</td><td contenteditable="true">1</td><td contenteditable="true"></td></tr>
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td contenteditable="true" colspan="2">Summe Kommunikative Textgestaltung</td>
                                    <td contenteditable="true">9</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="preview-subtitle">AusdrucksvermÃ¶gen / VerfÃ¼gbarkeit sprachlicher Mittel</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">Nr.</th>
                                    <th style="width: 65%">Anforderung</th>
                                    <th style="width: 15%">Punkte</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td contenteditable="true">1</td><td contenteditable="true">lÃ¶st sich vom Ausgangstext und formuliert eigenstÃ¤ndig.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">2</td><td contenteditable="true">verwendet einen sachlich wie stilistisch angemessenen und differenzierten allgemeinen und thematischen Wortschatz.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">3</td><td contenteditable="true">verwendet funktional einen sachlich wie stilistisch angemessenen und differenzierten Funktions- und Interpretationswortschatz.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">4</td><td contenteditable="true">verwendet einen variablen und dem jeweiligen Zieltextformat angemessenen Satzbau.</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td contenteditable="true" colspan="2">Summe AusdrucksvermÃ¶gen/VerfÃ¼gbarkeit sprachl. Mittel</td>
                                    <td contenteditable="true">9</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="preview-subtitle">Sprachrichtigkeit</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">Nr.</th>
                                    <th style="width: 65%">Anforderung</th>
                                    <th style="width: 15%">Punkte</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td contenteditable="true">1</td><td contenteditable="true">Wortschatz</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">2</td><td contenteditable="true">Grammatik</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">3</td><td contenteditable="true">Orthographie (Rechtschreibung und Zeichensetzung)</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td contenteditable="true" colspan="2">Summe Sprachrichtigkeit</td>
                                    <td contenteditable="true">9</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>

                        <p style="font-weight: bold; margin-top: 20px; font-size: 1.1em; color: #667eea;">
                            Summe Sprache Teil B: 27 Punkte
                        </p>
                        <p style="font-weight: bold; margin-top: 10px; font-size: 1.2em; color: #333;">
                            Gesamtpunktzahl Teil B (Inhalt + Sprache): ${teilBInhalt + 27} Punkte
                        </p>
                    </div>
                `;
            }

            // Add summary table before final total
            html += `
                <div class="preview-section" style="margin-top: 30px;">
                    <h2>GesamtÃ¼bersicht</h2>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 60%">Bereich</th>
                                <th style="width: 20%">Maximum</th>
                                <th style="width: 20%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (currentListeningMode) {
                html += `
                            <tr>
                                <td contenteditable="true">Listening Comprehension</td>
                                <td contenteditable="true">30</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Gesamtpunktzahl Inhalt Teil A</td>
                                <td contenteditable="true">${teilAInhalt}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Gesamtpunktzahl Sprache Teil A</td>
                                <td contenteditable="true">${teilALanguagePoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                `;
            } else {
                html += `
                            <tr>
                                <td contenteditable="true">Gesamtpunktzahl Inhalt Teil A</td>
                                <td contenteditable="true">${teilAInhalt}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Gesamtpunktzahl Sprache Teil A</td>
                                <td contenteditable="true">${teilALanguagePoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                `;
            }

            if (hasMediation) {
                html += `
                            <tr>
                                <td contenteditable="true">Gesamtpunktzahl Inhalt Teil B</td>
                                <td contenteditable="true">${teilBInhalt}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Gesamtpunktzahl Sprache Teil B</td>
                                <td contenteditable="true">27</td>
                                <td contenteditable="true"></td>
                            </tr>
                `;
            }

            const listeningPoints = currentListeningMode ? 30 : 0;
            const gesamtMax = listeningPoints + teilAInhalt + teilALanguagePoints + (hasMediation ? teilBInhalt + 27 : 0);
            html += `
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true">GESAMT${hasMediation ? ' (Teil A + Teil B)' : ''}</td>
                                <td contenteditable="true">${gesamtMax} Punkte</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Add NotenschlÃ¼ssel
            const gesamtpunkte = listeningPoints + teilAInhalt + teilALanguagePoints + (hasMediation ? teilBInhalt + 27 : 0);

            // Adjust grading scale header and values for Listening mode (180 points instead of 150)
            const scale150Header = currentListeningMode ? '180 Punkte' : '150 Punkte';
            const scale150Values = currentListeningMode ? {
                95: '171-180', 90: '162-170', 85: '154-161', 80: '144-153',
                75: '136-143', 70: '126-135', 65: '118-125', 60: '108-117',
                55: '100-107', 50: '90-99', 45: '82-89', 40: '72-81',
                33: '60-71', 27: '49-59', 20: '36-48', 0: '0-35'
            } : {
                95: '143-150', 90: '135-142', 85: '128-134', 80: '120-127',
                75: '113-119', 70: '105-112', 65: '98-104', 60: '90-97',
                55: '83-89', 50: '75-82', 45: '68-74', 40: '60-67',
                33: '50-59', 27: '41-49', 20: '30-40', 0: '0-29'
            };

            html += `
                <div class="preview-section" style="page-break-before: always; margin-top: 40px;">
                    <h2>NotenschlÃ¼ssel</h2>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Anteil (ab)</th>
                                <th>${scale150Header}</th>
                                <th>160 Punkte</th>
                                <th>200 Punkte</th>
                                <th>Notenpunkte (Q-Phase)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">95%</td><td contenteditable="true">${scale150Values[95]}</td><td contenteditable="true">152-160</td><td contenteditable="true">190-200</td><td contenteditable="true" style="font-weight: bold;">15</td></tr>
                            <tr><td contenteditable="true">90%</td><td contenteditable="true">${scale150Values[90]}</td><td contenteditable="true">144-151</td><td contenteditable="true">180-189</td><td contenteditable="true" style="font-weight: bold;">14</td></tr>
                            <tr><td contenteditable="true">85%</td><td contenteditable="true">${scale150Values[85]}</td><td contenteditable="true">136-143</td><td contenteditable="true">170-179</td><td contenteditable="true" style="font-weight: bold;">13</td></tr>
                            <tr><td contenteditable="true">80%</td><td contenteditable="true">${scale150Values[80]}</td><td contenteditable="true">128-135</td><td contenteditable="true">160-169</td><td contenteditable="true" style="font-weight: bold;">12</td></tr>
                            <tr><td contenteditable="true">75%</td><td contenteditable="true">${scale150Values[75]}</td><td contenteditable="true">120-127</td><td contenteditable="true">150-159</td><td contenteditable="true" style="font-weight: bold;">11</td></tr>
                            <tr><td contenteditable="true">70%</td><td contenteditable="true">${scale150Values[70]}</td><td contenteditable="true">112-119</td><td contenteditable="true">140-149</td><td contenteditable="true" style="font-weight: bold;">10</td></tr>
                            <tr><td contenteditable="true">65%</td><td contenteditable="true">${scale150Values[65]}</td><td contenteditable="true">104-111</td><td contenteditable="true">130-139</td><td contenteditable="true" style="font-weight: bold;">9</td></tr>
                            <tr><td contenteditable="true">60%</td><td contenteditable="true">${scale150Values[60]}</td><td contenteditable="true">96-103</td><td contenteditable="true">120-129</td><td contenteditable="true" style="font-weight: bold;">8</td></tr>
                            <tr><td contenteditable="true">55%</td><td contenteditable="true">${scale150Values[55]}</td><td contenteditable="true">88-95</td><td contenteditable="true">110-119</td><td contenteditable="true" style="font-weight: bold;">7</td></tr>
                            <tr><td contenteditable="true">50%</td><td contenteditable="true">${scale150Values[50]}</td><td contenteditable="true">80-87</td><td contenteditable="true">100-109</td><td contenteditable="true" style="font-weight: bold;">6</td></tr>
                            <tr><td contenteditable="true">45%</td><td contenteditable="true">${scale150Values[45]}</td><td contenteditable="true">72-79</td><td contenteditable="true">90-99</td><td contenteditable="true" style="font-weight: bold;">5</td></tr>
                            <tr><td contenteditable="true">40%</td><td contenteditable="true">${scale150Values[40]}</td><td contenteditable="true">64-71</td><td contenteditable="true">80-89</td><td contenteditable="true" style="font-weight: bold;">4</td></tr>
                            <tr><td contenteditable="true">33%</td><td contenteditable="true">${scale150Values[33]}</td><td contenteditable="true">53-63</td><td contenteditable="true">66-79</td><td contenteditable="true" style="font-weight: bold;">3</td></tr>
                            <tr><td contenteditable="true">27%</td><td contenteditable="true">${scale150Values[27]}</td><td contenteditable="true">43-52</td><td contenteditable="true">54-65</td><td contenteditable="true" style="font-weight: bold;">2</td></tr>
                            <tr><td contenteditable="true">20%</td><td contenteditable="true">${scale150Values[20]}</td><td contenteditable="true">32-42</td><td contenteditable="true">40-53</td><td contenteditable="true" style="font-weight: bold;">1</td></tr>
                            <tr><td contenteditable="true">0%</td><td contenteditable="true">${scale150Values[0]}</td><td contenteditable="true">0-31</td><td contenteditable="true">0-39</td><td contenteditable="true" style="font-weight: bold;">0</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            outputDiv.innerHTML = html;
        }

        function downloadAsDocx() {
            if (!currentContentData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }
            generateWordHTML(currentContentData, 'docx');
        }

        function downloadAsOdt() {
            if (!currentContentData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }
            generateWordHTML(currentContentData, 'odt');
        }

        function printAsPdf() {
            if (!currentContentData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }

            // Open print dialog which allows saving as PDF
            window.print();
        }

        function generateWordHTML(contentData, format) {
            // Separate Teil A and Teil B content
            let teilAInhalt = 0;
            let teilBInhalt = 0;
            let teilATasks = [];
            let teilBTasks = [];

            contentData.teilaufgaben.forEach(ta => {
                if (ta.typ === 'Mediation') {
                    teilBTasks.push(ta);
                    ta.kriterien.forEach(k => {
                        if (typeof k.punkte === 'number') teilBInhalt += k.punkte;
                    });
                } else {
                    teilATasks.push(ta);
                    ta.kriterien.forEach(k => {
                        if (typeof k.punkte === 'number') teilAInhalt += k.punkte;
                    });
                }
            });

            // Detect exam type
            const isListening = contentData.teilaufgaben.some(ta => ta.name.includes('Teil B') && ta.typ !== 'Mediation');
            const hasMediation = teilBTasks.length > 0;

            // Determine language points for Teil A
            let teilALanguagePoints, teilAKommPoints, teilAAusdrPoints, teilASprachPoints;
            if (isListening) {
                teilALanguagePoints = 72;
                teilAKommPoints = 24;
                teilAAusdrPoints = 24;
                teilASprachPoints = 24;
            } else if (!hasMediation) {
                // EF mode
                teilALanguagePoints = 90;
                teilAKommPoints = 30;
                teilAAusdrPoints = 30;
                teilASprachPoints = 30;
            } else {
                // Q1/Q2 with Mediation
                teilALanguagePoints = 63;
                teilAKommPoints = 21;
                teilAAusdrPoints = 21;
                teilASprachPoints = 21;
            }

            // Teil B language points (for Mediation)
            const teilBKommPoints = 9;
            const teilBAusdrPoints = 9;
            const teilBSprachPoints = 9;
            const teilBLanguagePoints = 27;

            let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Erwartungshorizont Englisch NRW</title>
    <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: Arial, sans-serif; margin: 2cm; font-size: 11pt; }
        h1 { font-size: 16pt; margin-bottom: 0.5cm; }
        h2 { font-size: 14pt; margin-top: 0.8cm; margin-bottom: 0.3cm; }
        h3 { font-size: 12pt; margin-top: 0.5cm; margin-bottom: 0.2cm; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 0.5cm; table-layout: fixed; }
        th, td { border: 1px solid black; padding: 6px; text-align: left; vertical-align: top; word-wrap: break-word; overflow-wrap: break-word; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .sum-row { background-color: #e8e8e8; font-weight: bold; }
        .col-nr { width: 5%; }
        .col-text { width: 65%; }
        .col-points { width: 15%; }
    </style>
</head>
<body>
    <h1>Bewertungsbogen fÃ¼r: ___________________________</h1>
${isListening ? `
    <h2>Teil A: Listening Comprehension</h2>
    <p style="font-style: italic; margin-bottom: 0.5cm;">30 Punkte (wird separat bewertet)</p>

    <h2>Teil B: Inhaltliche Leistung</h2>` : `
    <h2>Teil A: Inhaltliche Leistung</h2>`}`;

            // Generate Teil A content tables
            teilATasks.forEach(ta => {
                let taPoints = ta.kriterien.reduce((sum, k) => sum + (typeof k.punkte === 'number' ? k.punkte : 0), 0);

                html += `
    <h3>${ta.name} (${ta.typ})</h3>
    <table style="width: 17cm;">
        <col style="width: 0.8cm;" />
        <col style="width: 11cm;" />
        <col style="width: 2.6cm;" />
        <col style="width: 2.6cm;" />
        <tr>
            <th>Nr.</th>
            <th>Anforderungen</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr>
            <td colspan="4"><strong>Die SchÃ¼lerin/der SchÃ¼ler...</strong></td>
        </tr>`;

                ta.kriterien.forEach(k => {
                    html += `
        <tr>
            <td>${k.nr}</td>
            <td>${k.text}</td>
            <td>${k.punkte}</td>
            <td></td>
        </tr>`;
                });

                html += `
        <tr class="sum-row">
            <td colspan="2">SUMME ${ta.name.toUpperCase()}</td>
            <td>${taPoints}</td>
            <td></td>
        </tr>
    </table>`;
            });

            html += `
    <p style="font-weight:bold; margin-top:0.5cm;">Summe inhaltliche Leistung ${isListening ? 'Teil B' : 'Teil A'}: ${teilAInhalt} Punkte</p>

    <h2>${isListening ? 'Teil B' : 'Teil A'}: Sprachliche Leistung / Darstellungsleistung</h2>

    <h3>Kommunikative Textgestaltung</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen: Der SchÃ¼ler/Die SchÃ¼lerin</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr><td>1</td><td>richtet seinen/ihren Text konsequent und explizit im Sinne der Aufgabenstellung auf die Intention und den/die Adressaten aus.</td><td>${Math.ceil(teilAKommPoints * 0.286)}</td><td></td></tr>
        <tr><td>2</td><td>beachtet die Textsortenmerkmale der jeweils geforderten Zieltextformate.</td><td>${Math.ceil(teilAKommPoints * 0.19)}</td><td></td></tr>
        <tr><td>3</td><td>erstellt einen sachgerecht strukturierten leserfreundlichen Text, u.a. durch sprachliche VerknÃ¼pfungen, AbsÃ¤tze als erkennbare Sinnabschnitte.</td><td>${Math.ceil(teilAKommPoints * 0.19)}</td><td></td></tr>
        <tr><td>4</td><td>formuliert hinreichend ausfÃ¼hrlich, aber ohne unnÃ¶tige Wiederholungen und UmstÃ¤ndlichkeiten.</td><td>${Math.ceil(teilAKommPoints * 0.19)}</td><td></td></tr>
        <tr><td>5</td><td>belegt seine Aussagen durch eine funktionale Verwendung von Verweisen und Zitaten.</td><td>${Math.floor(teilAKommPoints * 0.143)}</td><td></td></tr>
        <tr class="sum-row"><td colspan="2">SUMME Kommunikative Textgestaltung</td><td>${teilAKommPoints}</td><td></td></tr>
    </table>

    <h3>AusdrucksvermÃ¶gen / VerfÃ¼gbarkeit sprachlicher Mittel</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen: Der SchÃ¼ler/Die SchÃ¼lerin</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr><td>1</td><td>lÃ¶st sich vom Ausgangstext und formuliert eigenstÃ¤ndig.</td><td>${Math.ceil(teilAAusdrPoints * 0.19)}</td><td></td></tr>
        <tr><td>2</td><td>verwendet einen sachlich wie stilistisch angemessenen und differenzierten allgemeinen und thematischen Wortschatz.</td><td>${Math.ceil(teilAAusdrPoints * 0.238)}</td><td></td></tr>
        <tr><td>3</td><td>verwendet funktional einen sachlich wie stilistisch angemessenen und differenzierten Funktions- und Interpretationswortschatz.</td><td>${Math.ceil(teilAAusdrPoints * 0.238)}</td><td></td></tr>
        <tr><td>4</td><td>verwendet einen variablen und dem jeweiligen Zieltextformat angemessenen Satzbau.</td><td>${Math.floor(teilAAusdrPoints * 0.333)}</td><td></td></tr>
        <tr class="sum-row"><td colspan="2">SUMME AusdrucksvermÃ¶gen/VerfÃ¼gbarkeit sprachl. Mittel</td><td>${teilAAusdrPoints}</td><td></td></tr>
    </table>

    <h3>Sprachrichtigkeit</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen: Der SchÃ¼ler/Die SchÃ¼lerin<br>beachtet die Normen der sprachlichen Korrektheit im Sinne einer gelingenden Kommunikation.</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr><td>1</td><td>Wortschatz</td><td>${Math.ceil(teilASprachPoints * 0.381)}</td><td></td></tr>
        <tr><td>2</td><td>Grammatik</td><td>${Math.ceil(teilASprachPoints * 0.381)}</td><td></td></tr>
        <tr><td>3</td><td>Orthographie (Rechtschreibung und Zeichensetzung)</td><td>${Math.floor(teilASprachPoints * 0.238)}</td><td></td></tr>
        <tr class="sum-row"><td colspan="2">SUMME Sprachrichtigkeit</td><td>${teilASprachPoints}</td><td></td></tr>
    </table>

    <p style="font-weight:bold; margin-top:0.5cm;">SUMME SPRACHE ${isListening ? 'TEIL B' : 'TEIL A'}: ${teilALanguagePoints} Punkte</p>
    <p style="font-weight:bold; font-size:14pt; margin-top:0.5cm;">SUMME ${isListening ? 'TEIL B' : 'TEIL A'} GESAMT (Inhalt + Sprache): ${teilAInhalt + teilALanguagePoints} Punkte</p>${isListening ? `
    <p style="font-weight:bold; font-size:14pt; margin-top:0.5cm;">SUMME GESAMT (Teil A Listening 30P + Teil B ${teilAInhalt + teilALanguagePoints}P): ${30 + teilAInhalt + teilALanguagePoints} Punkte</p>` : ''}`;

            // Add Teil B (Mediation) if present
            if (hasMediation) {
                html += `

    <div style="page-break-before: always;"></div>
    <h2>Teil B: Mediation - Inhaltliche Leistung</h2>`;

                teilBTasks.forEach(ta => {
                    let taPoints = ta.kriterien.reduce((sum, k) => sum + (typeof k.punkte === 'number' ? k.punkte : 0), 0);

                    html += `
    <h3>${ta.name} (${ta.typ})</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr>
            <td colspan="4"><strong>Die SchÃ¼lerin/der SchÃ¼ler...</strong></td>
        </tr>`;

                    ta.kriterien.forEach(k => {
                        html += `
        <tr>
            <td>${k.nr}</td>
            <td>${k.text}</td>
            <td>${k.punkte}</td>
            <td></td>
        </tr>`;
                    });

                    html += `
        <tr class="sum-row">
            <td colspan="2">SUMME ${ta.name.toUpperCase()}</td>
            <td>${taPoints}</td>
            <td></td>
        </tr>
    </table>`;
                });

                html += `
    <p style="font-weight:bold; margin-top:0.5cm;">Summe inhaltliche Leistung Teil B: ${teilBInhalt} Punkte</p>

    <h2>Teil B: Sprachliche Leistung / Darstellungsleistung</h2>

    <h3>Kommunikative Textgestaltung</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen: Der SchÃ¼ler/Die SchÃ¼lerin</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr><td>1</td><td>richtet seinen/ihren Text konsequent und explizit im Sinne der Aufgabenstellung auf die Intention und den/die Adressaten aus.</td><td>3</td><td></td></tr>
        <tr><td>2</td><td>beachtet die Textsortenmerkmale der jeweils geforderten Zieltextformate.</td><td>2</td><td></td></tr>
        <tr><td>3</td><td>erstellt einen sachgerecht strukturierten leserfreundlichen Text, u.a. durch sprachliche VerknÃ¼pfungen, AbsÃ¤tze als erkennbare Sinnabschnitte.</td><td>2</td><td></td></tr>
        <tr><td>4</td><td>formuliert hinreichend ausfÃ¼hrlich, aber ohne unnÃ¶tige Wiederholungen und UmstÃ¤ndlichkeiten.</td><td>1</td><td></td></tr>
        <tr><td>5</td><td>belegt seine Aussagen durch eine funktionale Verwendung von Verweisen und Zitaten.</td><td>1</td><td></td></tr>
        <tr class="sum-row"><td colspan="2">SUMME Kommunikative Textgestaltung</td><td>${teilBKommPoints}</td><td></td></tr>
    </table>

    <h3>AusdrucksvermÃ¶gen / VerfÃ¼gbarkeit sprachlicher Mittel</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen: Der SchÃ¼ler/Die SchÃ¼lerin</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr><td>1</td><td>lÃ¶st sich vom Ausgangstext und formuliert eigenstÃ¤ndig.</td><td>2</td><td></td></tr>
        <tr><td>2</td><td>verwendet einen sachlich wie stilistisch angemessenen und differenzierten allgemeinen und thematischen Wortschatz.</td><td>2</td><td></td></tr>
        <tr><td>3</td><td>verwendet funktional einen sachlich wie stilistisch angemessenen und differenzierten Funktions- und Interpretationswortschatz.</td><td>2</td><td></td></tr>
        <tr><td>4</td><td>verwendet einen variablen und dem jeweiligen Zieltextformat angemessenen Satzbau.</td><td>3</td><td></td></tr>
        <tr class="sum-row"><td colspan="2">SUMME AusdrucksvermÃ¶gen/VerfÃ¼gbarkeit sprachl. Mittel</td><td>${teilBAusdrPoints}</td><td></td></tr>
    </table>

    <h3>Sprachrichtigkeit</h3>
    <table>
        <colgroup>
            <col width="5%" style="width: 5%;">
            <col width="65%" style="width: 65%;">
            <col width="15%" style="width: 15%;">
            <col width="15%" style="width: 15%;">
        </colgroup>
        <tr>
            <th>Nr.</th>
            <th>Anforderungen: Der SchÃ¼ler/Die SchÃ¼lerin<br>beachtet die Normen der sprachlichen Korrektheit im Sinne einer gelingenden Kommunikation.</th>
            <th>max. Punkte</th>
            <th>Erreichte Punkte</th>
        </tr>
        <tr><td>1</td><td>Wortschatz</td><td>3</td><td></td></tr>
        <tr><td>2</td><td>Grammatik</td><td>3</td><td></td></tr>
        <tr><td>3</td><td>Orthographie (Rechtschreibung und Zeichensetzung)</td><td>3</td><td></td></tr>
        <tr class="sum-row"><td colspan="2">SUMME Sprachrichtigkeit</td><td>${teilBSprachPoints}</td><td></td></tr>
    </table>

    <p style="font-weight:bold; margin-top:0.5cm;">SUMME SPRACHE TEIL B: ${teilBLanguagePoints} Punkte</p>
    <p style="font-weight:bold; font-size:14pt; margin-top:0.5cm;">SUMME TEIL B GESAMT (Inhalt + Sprache): ${teilBInhalt + teilBLanguagePoints} Punkte</p>
    <p style="font-weight:bold; font-size:14pt; margin-top:0.5cm;">GESAMTPUNKTZAHL (Teil A ${teilAInhalt + teilALanguagePoints}P + Teil B ${teilBInhalt + teilBLanguagePoints}P): ${teilAInhalt + teilALanguagePoints + teilBInhalt + teilBLanguagePoints} Punkte</p>`;
            }

            html += `

    <div style="page-break-before: always;"></div>
    <h2 style="margin-top: 1cm;">NotenschlÃ¼ssel</h2>
    <table>
        <colgroup>
            <col width="15%" style="width: 15%;">
            <col width="17%" style="width: 17%;">
            <col width="17%" style="width: 17%;">
            <col width="17%" style="width: 17%;">
            <col width="34%" style="width: 34%;">
        </colgroup>
        <tr>
            <th>Anteil (ab)</th>
            <th>150 Punkte</th>
            <th>160 Punkte</th>
            <th>200 Punkte</th>
            <th>Notenpunkte (Q-Phase)</th>
        </tr>
        <tr><td>95%</td><td>143-150</td><td>152-160</td><td>190-200</td><td style="font-weight: bold;">15</td></tr>
        <tr><td>90%</td><td>135-142</td><td>144-151</td><td>180-189</td><td style="font-weight: bold;">14</td></tr>
        <tr><td>85%</td><td>128-134</td><td>136-143</td><td>170-179</td><td style="font-weight: bold;">13</td></tr>
        <tr><td>80%</td><td>120-127</td><td>128-135</td><td>160-169</td><td style="font-weight: bold;">12</td></tr>
        <tr><td>75%</td><td>113-119</td><td>120-127</td><td>150-159</td><td style="font-weight: bold;">11</td></tr>
        <tr><td>70%</td><td>105-112</td><td>112-119</td><td>140-149</td><td style="font-weight: bold;">10</td></tr>
        <tr><td>65%</td><td>98-104</td><td>104-111</td><td>130-139</td><td style="font-weight: bold;">9</td></tr>
        <tr><td>60%</td><td>90-97</td><td>96-103</td><td>120-129</td><td style="font-weight: bold;">8</td></tr>
        <tr><td>55%</td><td>83-89</td><td>88-95</td><td>110-119</td><td style="font-weight: bold;">7</td></tr>
        <tr><td>50%</td><td>75-82</td><td>80-87</td><td>100-109</td><td style="font-weight: bold;">6</td></tr>
        <tr><td>45%</td><td>68-74</td><td>72-79</td><td>90-99</td><td style="font-weight: bold;">5</td></tr>
        <tr><td>40%</td><td>60-67</td><td>64-71</td><td>80-89</td><td style="font-weight: bold;">4</td></tr>
        <tr><td>33%</td><td>50-59</td><td>53-63</td><td>66-79</td><td style="font-weight: bold;">3</td></tr>
        <tr><td>27%</td><td>41-49</td><td>43-52</td><td>54-65</td><td style="font-weight: bold;">2</td></tr>
        <tr><td>20%</td><td>30-40</td><td>32-42</td><td>40-53</td><td style="font-weight: bold;">1</td></tr>
        <tr><td>0%</td><td>0-29</td><td>0-31</td><td>0-39</td><td style="font-weight: bold;">0</td></tr>
    </table>

</body>
</html>`;

            const blob = new Blob(['\ufeff', html], {
                type: format === 'odt' ? 'application/vnd.oasis.opendocument.text' : 'application/msword'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Erwartungshorizont_Englisch_NRW.${format === 'odt' ? 'odt' : 'doc'}`;
            link.click();
        }

        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('task2Text').value = '';
            document.getElementById('task3aText').value = '';
            document.getElementById('task3bText').value = '';
            document.getElementById('mediationText').value = '';
            document.getElementById('output').className = 'output empty';
            document.getElementById('output').innerHTML = 'Hier erscheint dein Erwartungshorizont...';
            document.getElementById('downloadButtons').classList.add('hidden');
            currentContentData = null;
        }

        // Subject Tab Switching
        function switchSubject(subject) {
            // Hide all content
            document.getElementById('contentEnglisch').style.display = 'none';
            document.getElementById('contentPhilosophie').style.display = 'none';

            // Remove active class from all tabs
            document.getElementById('tabEnglisch').classList.remove('active');
            document.getElementById('tabPhilosophie').classList.remove('active');

            // Show selected content and activate tab
            if (subject === 'englisch') {
                document.getElementById('contentEnglisch').style.display = 'block';
                document.getElementById('tabEnglisch').classList.add('active');
            } else if (subject === 'philosophie') {
                document.getElementById('contentPhilosophie').style.display = 'block';
                document.getElementById('tabPhilosophie').classList.add('active');
            }
        }

        // ========== PHILOSOPHIE FUNCTIONS ==========
        let currentPhiloData = null;

        async function generateErwartungshorizontPhilo() {
            const primaryText = document.getElementById('philoPrimaryText').value.trim();
            const task1 = document.getElementById('philoTask1').value.trim();
            const task2 = document.getElementById('philoTask2').value.trim();
            const task3 = document.getElementById('philoTask3').value.trim();
            const outputDiv = document.getElementById('outputPhilo');
            const generateBtn = document.querySelector('.generate-btn');
            const downloadButtons = document.getElementById('downloadButtonsPhilo');

            if (!primaryText || !task1 || !task2 || !task3) {
                alert('Bitte fÃ¼lle alle Felder aus (Klausurtext + alle 3 Aufgaben)!');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generiere mit Google AI...';
            outputDiv.className = 'output loading';
            outputDiv.innerHTML = 'Erwartungshorizont wird erstellt, bitte warten...';
            downloadButtons.classList.add('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'philosophie',
                        primaryText,
                        teilaufgabeA: task1,
                        teilaufgabeB: task2,
                        teilaufgabeC: task3
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Fehler bei der Generierung');
                }

                const data = await response.json();

                if (data.success) {
                    currentPhiloData = data.data;
                    renderPhilosophieOutput(data.data);
                    downloadButtons.classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }

            } catch (error) {
                console.error('Generation Error:', error);
                outputDiv.className = 'output';
                outputDiv.innerHTML = `<p style="color: #d32f2f;">âŒ Fehler: ${error.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Erwartungshorizont erstellen';
            }
        }

        function renderPhilosophieOutput(contentData) {
            const outputDiv = document.getElementById('outputPhilo');
            outputDiv.className = 'output';

            let html = `
                <div class="preview-section">
                    <h2>Erwartungshorizont Philosophie</h2>
            `;

            // Render each Teilaufgabe
            contentData.teilaufgaben.forEach((ta, index) => {
                const totalPoints = ta.kriterien.reduce((sum, k) => {
                    return sum + (typeof k.punkte === 'number' ? k.punkte : 0);
                }, 0);

                html += `
                    <div class="preview-section">
                        <h3 class="preview-subtitle">${ta.name} (${totalPoints} Punkte)</h3>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 60%;">Kriterium</th>
                                    <th style="width: 15%;">Max. Punkte</th>
                                    <th style="width: 25%;">Erreichte Punkte</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                ta.kriterien.forEach(krit => {
                    const punkteStr = typeof krit.punkte === 'number' ? krit.punkte : `(${krit.punkte})`;
                    html += `
                        <tr>
                            <td contenteditable="true">${krit.text}</td>
                            <td contenteditable="true">${punkteStr}</td>
                            <td contenteditable="true"></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Add summary table
            const inhaltTotal = contentData.teilaufgaben.reduce((sum, ta) => {
                return sum + ta.kriterien.reduce((s, k) => {
                    return s + (typeof k.punkte === 'number' ? k.punkte : 0);
                }, 0);
            }, 0);

            html += `
                <div class="preview-section">
                    <h3 class="preview-subtitle">GesamtÃ¼bersicht</h3>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Bereich</th>
                                <th>Max. Punkte</th>
                                <th>Erreichte Punkte</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">Inhaltliche Leistung</td>
                                <td contenteditable="true">${inhaltTotal}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Darstellungsleistung</td>
                                <td contenteditable="true">20</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true">GESAMT</td>
                                <td contenteditable="true">100 Punkte</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Add NotenschlÃ¼ssel (standard 100-Punkte-Skala)
            html += `
                <div class="preview-section" style="page-break-before: always; margin-top: 40px;">
                    <h2>NotenschlÃ¼ssel</h2>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Anteil (ab)</th>
                                <th>100 Punkte</th>
                                <th>Notenpunkte (Q-Phase)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">95%</td><td contenteditable="true">95-100</td><td contenteditable="true" style="font-weight: bold;">15</td></tr>
                            <tr><td contenteditable="true">90%</td><td contenteditable="true">90-94</td><td contenteditable="true" style="font-weight: bold;">14</td></tr>
                            <tr><td contenteditable="true">85%</td><td contenteditable="true">85-89</td><td contenteditable="true" style="font-weight: bold;">13</td></tr>
                            <tr><td contenteditable="true">80%</td><td contenteditable="true">80-84</td><td contenteditable="true" style="font-weight: bold;">12</td></tr>
                            <tr><td contenteditable="true">75%</td><td contenteditable="true">75-79</td><td contenteditable="true" style="font-weight: bold;">11</td></tr>
                            <tr><td contenteditable="true">70%</td><td contenteditable="true">70-74</td><td contenteditable="true" style="font-weight: bold;">10</td></tr>
                            <tr><td contenteditable="true">65%</td><td contenteditable="true">65-69</td><td contenteditable="true" style="font-weight: bold;">9</td></tr>
                            <tr><td contenteditable="true">60%</td><td contenteditable="true">60-64</td><td contenteditable="true" style="font-weight: bold;">8</td></tr>
                            <tr><td contenteditable="true">55%</td><td contenteditable="true">55-59</td><td contenteditable="true" style="font-weight: bold;">7</td></tr>
                            <tr><td contenteditable="true">50%</td><td contenteditable="true">50-54</td><td contenteditable="true" style="font-weight: bold;">6</td></tr>
                            <tr><td contenteditable="true">45%</td><td contenteditable="true">45-49</td><td contenteditable="true" style="font-weight: bold;">5</td></tr>
                            <tr><td contenteditable="true">40%</td><td contenteditable="true">40-44</td><td contenteditable="true" style="font-weight: bold;">4</td></tr>
                            <tr><td contenteditable="true">33%</td><td contenteditable="true">33-39</td><td contenteditable="true" style="font-weight: bold;">3</td></tr>
                            <tr><td contenteditable="true">27%</td><td contenteditable="true">27-32</td><td contenteditable="true" style="font-weight: bold;">2</td></tr>
                            <tr><td contenteditable="true">20%</td><td contenteditable="true">20-26</td><td contenteditable="true" style="font-weight: bold;">1</td></tr>
                            <tr><td contenteditable="true">0%</td><td contenteditable="true">0-19</td><td contenteditable="true" style="font-weight: bold;">0</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            outputDiv.innerHTML = html;
        }

        function clearAllPhilo() {
            document.getElementById('philoPrimaryText').value = '';
            document.getElementById('philoTask1').value = '';
            document.getElementById('philoTask2').value = '';
            document.getElementById('philoTask3').value = '';
            document.getElementById('outputPhilo').className = 'output empty';
            document.getElementById('outputPhilo').innerHTML = 'Hier erscheint dein Erwartungshorizont...';
            document.getElementById('downloadButtonsPhilo').classList.add('hidden');
            currentPhiloData = null;
        }

        function printAsPdfPhilo() {
            if (!currentPhiloData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }
            window.print();
        }
    </script>
</body>
</html>
