<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erwartungshorizont Generator - Philosophie</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="../shared/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="../shared/pdf-upload.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="../images/schoollogoonly.png" alt="School Logo" class="header-logo">
                <h1>Erwartungshorizont Generator</h1>
            </div>
            <p>f√ºr Klausuren Sek II NRW</p>
        </div>

        <!-- Subject Tabs -->
        <div class="subject-tabs">
            <div class="subject-tabs-container">
                <a href="englisch.html" class="subject-tab">Englisch</a>
                <a href="philosophie.html" class="subject-tab active">Philosophie</a>
                <a href="mathematik.html" class="subject-tab">Mathematik</a>
                <a href="deutsch.html" class="subject-tab">Deutsch</a>
            </div>
        </div>

        <!-- Philosophie Content -->
        <div class="subject-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div class="glass-card">
                    <div class="info-box">
                        <h3>So funktioniert's:</h3>
                        <ul>
                            <li>Einfach Klausur als PDF hochladen oder Texte und Aufgaben manuell einf√ºgen</li>
                            <li>Der Generator erkennt automatisch, ob es sich um Texterschlie√üung oder Problemer√∂rterung handelt</li>
                            <li>Erhalte einen strukturierten Erwartungshorizont nach NRW-Kriterien</li>
                            <li>Bearbeite ihn direkt im Browser und lade ihn als PDF herunter</li>
                        </ul>
                        <p style="margin-top: 12px;">
                            WICHTIG: Das PDF muss textbasiert sein, nicht gescannt. Check: Kannst du Text im PDF markieren? Nur dann funktioniert der Generator.
                        </p>
                        <p style="margin-top: 8px;">
                            Der Generator kann Fehler machen: Bitte √ºberpr√ºfe alle L√∂sungen.
                        </p>
                    </div>

                    <div class="pdf-upload-section">
                        <label style="font-size: 1.05em; font-weight: 600; margin-bottom: 12px; display: block;">
                            üìÑ Klausur-PDF hochladen (Optional)
                        </label>
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 15px;">
                            Lade eine PDF-Datei mit dem Klausurtext und Aufgaben hoch oder ziehe sie per Drag & Drop hierher
                        </p>
                        <div id="pdfDropZone" class="pdf-drop-zone">
                            <div style="font-size: 3em; margin-bottom: 10px;">üìÑ</div>
                            <p style="color: white; font-weight: 500; margin-bottom: 5px;">PDF hier ablegen</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em;">oder klicken zum Ausw√§hlen</p>
                        </div>
                        <input type="file" id="pdfUpload" accept=".pdf" style="display: none;">
                        <button type="button" class="pdf-select-btn" onclick="document.getElementById('pdfUpload').click()">
                            üìé Datei ausw√§hlen
                        </button>
                        <p id="pdfStatus" style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-top: 10px; display: none;"></p>
                    </div>

                    <div class="input-section">
                        <label for="philoPrimaryText">Klausurtext (Prim√§rtext / Zitat)</label>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: -8px; margin-bottom: 10px;">
                            Bei Texterschlie√üung: Der philosophische Text. Bei Problemer√∂rterung: Das Zitat oder Dilemma.
                        </p>
                        <textarea
                            id="philoPrimaryText"
                            rows="12"
                            placeholder="F√ºge hier den philosophischen Prim√§rtext oder das Zitat ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="philoTask1">Aufgabe 1</label>
                        <textarea
                            id="philoTask1"
                            rows="4"
                            placeholder="F√ºge hier die Aufgabenstellung f√ºr Aufgabe 1 ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="philoTask2">Aufgabe 2</label>
                        <textarea
                            id="philoTask2"
                            rows="4"
                            placeholder="F√ºge hier die Aufgabenstellung f√ºr Aufgabe 2 ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="philoTask3">Aufgabe 3</label>
                        <textarea
                            id="philoTask3"
                            rows="4"
                            placeholder="F√ºge hier die Aufgabenstellung f√ºr Aufgabe 3 ein..."
                        ></textarea>
                    </div>

                    <div class="button-container">
                        <button class="generate-btn" onclick="generateErwartungshorizontPhilo()">
                            Erwartungshorizont erstellen
                        </button>
                    </div>
                </div>

                <div class="glass-card-strong output-section">
                    <label>Generierter Erwartungshorizont:</label>
                    <div id="outputPhilo" class="output empty">
                        Hier erscheint dein Erwartungshorizont...
                    </div>
                    <div class="download-buttons hidden" id="downloadButtonsPhilo">
                        <button class="download-btn btn-pdf" onclick="printAsPdfPhilo()">
                            Als PDF speichern
                        </button>
                        <button class="download-btn" onclick="copyToClipboardPhilo()">
                            üìã Kopieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPhiloData = null;

        // Initialize PDF upload on page load
        document.addEventListener('DOMContentLoaded', function() {
            initPDFUpload('pdfUpload', 'pdfDropZone', 'pdfStatus', 'philosophie', {
                'primaryText': 'philoPrimaryText',
                'task1': 'philoTask1',
                'task2': 'philoTask2',
                'task3': 'philoTask3'
            });
        });

        async function generateErwartungshorizontPhilo() {
            const primaryText = document.getElementById('philoPrimaryText').value.trim();
            const task1 = document.getElementById('philoTask1').value.trim();
            const task2 = document.getElementById('philoTask2').value.trim();
            const task3 = document.getElementById('philoTask3').value.trim();
            const outputDiv = document.getElementById('outputPhilo');
            const generateBtn = document.querySelector('.generate-btn');
            const downloadButtons = document.getElementById('downloadButtonsPhilo');

            if (!primaryText || !task1 || !task2 || !task3) {
                alert('Bitte f√ºlle alle Felder aus (Klausurtext + alle 3 Aufgaben)!');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generiere mit Google AI...';
            outputDiv.className = 'output loading';
            outputDiv.innerHTML = 'Erwartungshorizont wird erstellt, bitte warten...';
            downloadButtons.classList.add('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'philosophie',
                        primaryText,
                        teilaufgabeA: task1,
                        teilaufgabeB: task2,
                        teilaufgabeC: task3
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Fehler bei der Generierung');
                }

                const data = await response.json();

                if (data.success) {
                    currentPhiloData = data.data;
                    renderPhilosophieOutput(data.data);
                    downloadButtons.classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }

            } catch (error) {
                console.error('Generation Error:', error);
                outputDiv.className = 'output';
                outputDiv.innerHTML = `<p style="color: #d32f2f;">Fehler: ${error.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Erwartungshorizont erstellen';
            }
        }

        function renderPhilosophieOutput(contentData) {
            const outputDiv = document.getElementById('outputPhilo');
            outputDiv.className = 'output';

            let html = `
                <div class="preview-section">
                    <h2>Erwartungshorizont Philosophie</h2>
            `;

            // Render each Teilaufgabe
            contentData.teilaufgaben.forEach((ta, index) => {
                const totalPoints = ta.kriterien.reduce((sum, k) => {
                    return sum + (typeof k.punkte === 'number' ? k.punkte : 0);
                }, 0);

                html += `
                    <div class="preview-section">
                        <h3 class="preview-subtitle">${ta.name} (${totalPoints} Punkte)</h3>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 60%;">Kriterium</th>
                                    <th style="width: 15%;">Max. Punkte</th>
                                    <th style="width: 25%;">Erreichte Punkte</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                ta.kriterien.forEach(krit => {
                    const punkteStr = typeof krit.punkte === 'number' ? krit.punkte : `(${krit.punkte})`;
                    html += `
                        <tr>
                            <td contenteditable="true">${krit.text}</td>
                            <td contenteditable="true">${punkteStr}</td>
                            <td contenteditable="true"></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Add Darstellungsleistung table
            html += `
                <div class="preview-section">
                    <h3 class="preview-subtitle">Darstellungsleistung (20 Punkte)</h3>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 60%;">Kriterium</th>
                                <th style="width: 15%;">Max. Punkte</th>
                                <th style="width: 25%;">Erreichte Punkte</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">strukturiert den Text schl√ºssig, stringent und gedanklich klar</td>
                                <td contenteditable="true">5</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">formuliert unter Beachtung der Fachsprache pr√§zise und begrifflich differenziert</td>
                                <td contenteditable="true">5</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">schreibt sprachlich richtig (Grammatik, Orthographie, Zeichensetzung) sowie syntaktisch und stilistisch sicher</td>
                                <td contenteditable="true">5</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">belegt Aussagen durch angemessenes und korrektes Zitieren</td>
                                <td contenteditable="true">5</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Add summary table
            const inhaltTotal = contentData.teilaufgaben.reduce((sum, ta) => {
                return sum + ta.kriterien.reduce((s, k) => {
                    return s + (typeof k.punkte === 'number' ? k.punkte : 0);
                }, 0);
            }, 0);

            html += `
                <div class="preview-section">
                    <h3 class="preview-subtitle">Gesamt√ºbersicht</h3>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Bereich</th>
                                <th>Max. Punkte</th>
                                <th>Erreichte Punkte</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">Inhaltliche Leistung</td>
                                <td contenteditable="true">${inhaltTotal}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Darstellungsleistung</td>
                                <td contenteditable="true">20</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true">GESAMT</td>
                                <td contenteditable="true">100 Punkte</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Add Notenschl√ºssel (standard 100-Punkte-Skala)
            html += `
                <div class="preview-section" style="page-break-before: always; margin-top: 40px;">
                    <h2>Notenschl√ºssel</h2>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Anteil (ab)</th>
                                <th>100 Punkte</th>
                                <th>Notenpunkte (Q-Phase)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">95%</td><td contenteditable="true">95-100</td><td contenteditable="true" style="font-weight: bold;">15</td></tr>
                            <tr><td contenteditable="true">90%</td><td contenteditable="true">90-94</td><td contenteditable="true" style="font-weight: bold;">14</td></tr>
                            <tr><td contenteditable="true">85%</td><td contenteditable="true">85-89</td><td contenteditable="true" style="font-weight: bold;">13</td></tr>
                            <tr><td contenteditable="true">80%</td><td contenteditable="true">80-84</td><td contenteditable="true" style="font-weight: bold;">12</td></tr>
                            <tr><td contenteditable="true">75%</td><td contenteditable="true">75-79</td><td contenteditable="true" style="font-weight: bold;">11</td></tr>
                            <tr><td contenteditable="true">70%</td><td contenteditable="true">70-74</td><td contenteditable="true" style="font-weight: bold;">10</td></tr>
                            <tr><td contenteditable="true">65%</td><td contenteditable="true">65-69</td><td contenteditable="true" style="font-weight: bold;">9</td></tr>
                            <tr><td contenteditable="true">60%</td><td contenteditable="true">60-64</td><td contenteditable="true" style="font-weight: bold;">8</td></tr>
                            <tr><td contenteditable="true">55%</td><td contenteditable="true">55-59</td><td contenteditable="true" style="font-weight: bold;">7</td></tr>
                            <tr><td contenteditable="true">50%</td><td contenteditable="true">50-54</td><td contenteditable="true" style="font-weight: bold;">6</td></tr>
                            <tr><td contenteditable="true">45%</td><td contenteditable="true">45-49</td><td contenteditable="true" style="font-weight: bold;">5</td></tr>
                            <tr><td contenteditable="true">40%</td><td contenteditable="true">40-44</td><td contenteditable="true" style="font-weight: bold;">4</td></tr>
                            <tr><td contenteditable="true">33%</td><td contenteditable="true">33-39</td><td contenteditable="true" style="font-weight: bold;">3</td></tr>
                            <tr><td contenteditable="true">27%</td><td contenteditable="true">27-32</td><td contenteditable="true" style="font-weight: bold;">2</td></tr>
                            <tr><td contenteditable="true">20%</td><td contenteditable="true">20-26</td><td contenteditable="true" style="font-weight: bold;">1</td></tr>
                            <tr><td contenteditable="true">0%</td><td contenteditable="true">0-19</td><td contenteditable="true" style="font-weight: bold;">0</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            outputDiv.innerHTML = html;
        }

        function copyToClipboardPhilo(event) {
            const outputDiv = document.getElementById('outputPhilo');
            const text = outputDiv.innerText;

            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Kopiert!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Fehler beim Kopieren: ' + err);
            });
        }

        function printAsPdfPhilo() {
            if (!currentPhiloData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }
            window.print();
        }
    </script>

    <footer style="text-align: center; padding: 20px 0; color: rgba(255,255,255,0.5); font-size: 0.85em;">
        From Simon with love ‚ù§Ô∏è
    </footer>
</body>
</html>
