<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erwartungshorizont Generator - Englisch</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="../shared/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="../shared/pdf-upload.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="../images/schoollogoonly.png" alt="School Logo" class="header-logo">
                <h1>Erwartungshorizont Generator</h1>
            </div>
            <p>f√ºr Klausuren Sek II NRW</p>
        </div>

        <!-- Subject Tabs -->
        <div class="subject-tabs">
            <div class="subject-tabs-container">
                <a href="englisch.html" class="subject-tab active">Englisch</a>
                <a href="philosophie.html" class="subject-tab">Philosophie</a>
                <a href="mathematik.html" class="subject-tab">Mathematik</a>
                <a href="deutsch.html" class="subject-tab">Deutsch</a>
            </div>
        </div>

        <!-- Englisch Content -->
        <div class="subject-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div class="glass-card">
                    <div class="info-box">
                        <h3>So funktioniert's:</h3>
                        <ul>
                            <li>Einfach Klausur als PDF hochladen oder Texte und Aufgaben manuell einf√ºgen</li>
                            <li>Bei manuellem Einf√ºgen: Bitte mit Author, Quelle etc.</li>
                            <li>Erhalte einen strukturierten Erwartungshorizont nach NRW-Kriterien</li>
                            <li>Bearbeite ihn direkt im Browser und lade ihn als PDF herunter</li>
                        </ul>
                        <p style="margin-top: 12px;">
                            WICHTIG: Das PDF muss textbasiert sein, nicht gescannt. Check: Kannst du Text im PDF markieren? Nur dann funktioniert der Generator.
                        </p>
                        <p style="margin-top: 8px;">
                            Der Generator kann Fehler machen: Bitte √ºberpr√ºfe alle L√∂sungen.
                        </p>
                    </div>

                    <div class="checkbox-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="listeningMode">
                            <span style="font-size: 1.05em;">Listening Comprehension inkludieren</span>
                        </label>
                    </div>

                    <div class="pdf-upload-section">
                        <label style="font-size: 1.05em; font-weight: 600; margin-bottom: 12px; display: block;">
                            üìÑ Klausur-PDF hochladen (Optional)
                        </label>
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 15px;">
                            Lade eine PDF-Datei mit den Klausurtexten und Aufgaben hoch oder ziehe sie per Drag & Drop hierher
                        </p>
                        <div id="pdfDropZone" class="pdf-drop-zone">
                            <div style="font-size: 3em; margin-bottom: 10px;">üìÑ</div>
                            <p style="color: white; font-weight: 500; margin-bottom: 5px;">PDF hier ablegen</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em;">oder klicken zum Ausw√§hlen</p>
                        </div>
                        <input type="file" id="pdfUpload" accept=".pdf" style="display: none;">
                        <button type="button" class="pdf-select-btn" onclick="document.getElementById('pdfUpload').click()">
                            üìé Datei ausw√§hlen
                        </button>
                        <p id="pdfStatus" style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-top: 10px; display: none;"></p>
                    </div>

                    <div class="input-section">
                        <label for="inputText">Teil A: Aufgabentext (Englisch)</label>
                        <textarea
                            id="inputText"
                            rows="10"
                            placeholder="F√ºge hier den englischen Text f√ºr Comprehension/Analysis ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="task2Text">Teil A - Aufgabe 2 (Analysis)</label>
                        <textarea
                            id="task2Text"
                            rows="3"
                            placeholder="Optional: Aufgabenstellung f√ºr die Analyse (z.B. 'Analyse the atmosphere in the extract...')..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="task3aText">Teil A - Aufgabe 3a (z.B. Discussion/Evaluation)</label>
                        <textarea
                            id="task3aText"
                            rows="4"
                            placeholder="F√ºge hier die Aufgabenstellung f√ºr Aufgabe 3a ein..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="task3bText">Teil A - Aufgabe 3b (z.B. Re-creation/Letter) - Optional</label>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: -8px; margin-bottom: 10px;">
                            Wenn freigelassen, wird nur Aufgabe 3a erstellt
                        </p>
                        <textarea
                            id="task3bText"
                            rows="4"
                            placeholder="F√ºge hier die Aufgabenstellung f√ºr Aufgabe 3b ein (optional)..."
                        ></textarea>
                    </div>

                    <div class="input-section">
                        <label for="mediationText">Teil B: Mediation Text (Deutsch)</label>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: -8px; margin-bottom: 10px;">
                            F√ºr Klausur ohne Mediation (EF) einfach freilassen
                        </p>
                        <textarea
                            id="mediationText"
                            rows="6"
                            placeholder="F√ºge hier den deutschen Text f√ºr Mediation ein..."
                        ></textarea>
                    </div>

                    <div class="button-container">
                        <button class="generate-btn" id="generateBtn" onclick="generateErwartungshorizont()">
                            Erwartungshorizont erstellen
                        </button>
                    </div>
                </div>

                <div class="glass-card-strong output-section">
                    <label>Generierter Erwartungshorizont:</label>
                    <div id="output" class="output empty">
                        Hier erscheint dein Erwartungshorizont...
                    </div>
                    <div class="download-buttons hidden" id="downloadButtons">
                        <button class="download-btn btn-pdf" onclick="printAsPdf()">
                            Als PDF speichern
                        </button>
                        <button class="download-btn" onclick="copyToClipboard()">
                            üìã Kopieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentContentData = null;
        let currentListeningMode = false;

        // Initialize PDF Upload
        document.addEventListener('DOMContentLoaded', function() {
            initPDFUpload('pdfUpload', 'pdfDropZone', 'pdfStatus', 'englisch', {
                'inputText': 'inputText',
                'task2Text': 'task2Text',
                'task3aText': 'task3aText',
                'task3bText': 'task3bText',
                'mediationText': 'mediationText'
            });
        });

        async function generateErwartungshorizont() {
            const inputText = document.getElementById('inputText').value.trim();
            const task2Text = document.getElementById('task2Text').value.trim();
            const task3aText = document.getElementById('task3aText').value.trim();
            const task3bText = document.getElementById('task3bText').value.trim();
            const mediationText = document.getElementById('mediationText').value.trim();
            const listeningMode = document.getElementById('listeningMode').checked;
            const outputDiv = document.getElementById('output');
            const generateBtn = document.getElementById('generateBtn');
            const downloadButtons = document.getElementById('downloadButtons');

            if (!inputText) {
                alert('Bitte gib mindestens einen Text f√ºr Teil A ein!');
                return;
            }

            if (!task3aText) {
                alert('Bitte gib mindestens eine Aufgabenstellung f√ºr Aufgabe 3a ein!');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generiere mit Google AI...';
            outputDiv.className = 'output loading';
            outputDiv.innerHTML = 'Erwartungshorizont wird erstellt, bitte warten...';
            downloadButtons.classList.add('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'englisch',
                        inputText,
                        task2Text,
                        task3aText,
                        task3bText,
                        mediationText,
                        listeningMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Fehler bei der Generierung');
                }

                currentContentData = data.data;
                currentListeningMode = listeningMode;
                displayErwartungshorizont(currentContentData);
                downloadButtons.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                outputDiv.className = 'output';
                outputDiv.innerHTML = `
                    <p style="color: #d32f2f; font-weight: 600;">Fehler bei der Generierung</p>
                    <p style="color: #666; margin-top: 10px;">${error.message}</p>
                    <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                        M√∂gliche Ursachen:<br>
                        - API nicht erreichbar<br>
                        - Google Gemini API-Key fehlt oder ung√ºltig<br>
                        - Netzwerkprobleme<br>
                        - Rate Limit erreicht (15 Anfragen/Minute)
                    </p>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Erwartungshorizont erstellen';
            }
        }

        function displayErwartungshorizont(contentData) {
            const outputDiv = document.getElementById('output');
            outputDiv.className = 'output';
            outputDiv.setAttribute('contenteditable', 'true');
            outputDiv.style.outline = 'none';

            let html = '<h1 contenteditable="true">Bewertungsbogen f√ºr: ___________________________</h1>';

            if (currentListeningMode) {
                html += `
                    <div class="preview-section">
                        <h3 contenteditable="true">Listening Comprehension</h3>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 70%">Bereich</th>
                                    <th style="width: 15%">Maximum</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td contenteditable="true">Listening Comprehension</td>
                                    <td contenteditable="true">30</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            html += '<h2>Teil A: Inhaltliche Leistung</h2>';

            let teilAInhalt = 0;
            let teilBInhalt = 0;

            const teilATasks = contentData.teilaufgaben.filter(ta => ta.typ !== 'Mediation');
            const teilBTasks = contentData.teilaufgaben.filter(ta => ta.typ === 'Mediation');

            const hasTask3a = teilATasks.some(ta => ta.name.includes('3a'));
            const hasTask3b = teilATasks.some(ta => ta.name.includes('3b'));
            const isChoiceTask = hasTask3a && hasTask3b;

            teilATasks.forEach((teilaufgabe, idx) => {
                html += `
                    <div class="preview-section">
                        <div class="preview-title" contenteditable="true">${teilaufgabe.name}</div>
                        <div class="preview-subtitle" contenteditable="true">Typ: ${teilaufgabe.typ}</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">Nr.</th>
                                    <th style="width: 65%">Anforderung</th>
                                    <th style="width: 15%">Punkte</th>
                                    <th style="width: 15%">Erreicht</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                teilaufgabe.kriterien.forEach(kriterium => {
                    html += `
                        <tr>
                            <td contenteditable="true">${kriterium.nr}</td>
                            <td contenteditable="true">${kriterium.text}</td>
                            <td contenteditable="true">${kriterium.punkte}</td>
                            <td contenteditable="true"></td>
                        </tr>
                    `;
                });

                const summe = teilaufgabe.kriterien.reduce((sum, k) => {
                    return sum + (typeof k.punkte === 'number' ? k.punkte : 0);
                }, 0);

                const isTask3b = teilaufgabe.name.includes('3b');
                if (!isChoiceTask || !isTask3b) {
                    teilAInhalt += summe;
                }

                html += `
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="2">Summe ${teilaufgabe.name}</td>
                                <td contenteditable="true">${summe}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            });

            const isListening = contentData.teilaufgaben.some(ta => ta.name.includes('Teil B') && ta.typ !== 'Mediation');
            const hasMediation = teilBTasks.length > 0;

            let teilALanguagePoints, teilAKommPoints, teilAAusdrPoints, teilASprachPoints;
            if (isListening) {
                teilALanguagePoints = 72;
                teilAKommPoints = 24;
                teilAAusdrPoints = 24;
                teilASprachPoints = 24;
            } else if (!hasMediation) {
                teilALanguagePoints = 90;
                teilAKommPoints = 30;
                teilAAusdrPoints = 30;
                teilASprachPoints = 30;
            } else {
                teilALanguagePoints = 63;
                teilAKommPoints = 21;
                teilAAusdrPoints = 21;
                teilASprachPoints = 21;
            }

            html += `
                <div class="preview-section">
                    <div class="preview-title">Teil A: Sprachliche Leistung / Darstellungsleistung</div>
                    <div class="preview-subtitle">Kommunikative Textgestaltung</div>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">Nr.</th>
                                <th style="width: 65%">Anforderung</th>
                                <th style="width: 15%">Punkte</th>
                                <th style="width: 15%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">1</td><td contenteditable="true">richtet seinen/ihren Text konsequent und explizit im Sinne der Aufgabenstellung auf die Intention und den/die Adressaten aus.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.286)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">2</td><td contenteditable="true">beachtet die Textsortenmerkmale der jeweils geforderten Zieltextformate.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">3</td><td contenteditable="true">erstellt einen sachgerecht strukturierten leserfreundlichen Text, u.a. durch sprachliche Verkn√ºpfungen, Abs√§tze als erkennbare Sinnabschnitte.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">4</td><td contenteditable="true">formuliert hinreichend ausf√ºhrlich, aber ohne unn√∂tige Wiederholungen und Umst√§ndlichkeiten.</td><td contenteditable="true">${Math.ceil(teilAKommPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">5</td><td contenteditable="true">belegt seine Aussagen durch eine funktionale Verwendung von Verweisen und Zitaten.</td><td contenteditable="true">${Math.floor(teilAKommPoints * 0.143)}</td><td contenteditable="true"></td></tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="2">Summe Kommunikative Textgestaltung</td>
                                <td contenteditable="true">${teilAKommPoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="preview-subtitle">Ausdrucksverm√∂gen / Verf√ºgbarkeit sprachlicher Mittel</div>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">Nr.</th>
                                <th style="width: 65%">Anforderung</th>
                                <th style="width: 15%">Punkte</th>
                                <th style="width: 15%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">1</td><td contenteditable="true">l√∂st sich vom Ausgangstext und formuliert eigenst√§ndig.</td><td contenteditable="true">${Math.ceil(teilAAusdrPoints * 0.19)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">2</td><td contenteditable="true">verwendet einen sachlich wie stilistisch angemessenen und differenzierten allgemeinen und thematischen Wortschatz.</td><td contenteditable="true">${Math.ceil(teilAAusdrPoints * 0.238)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">3</td><td contenteditable="true">verwendet funktional einen sachlich wie stilistisch angemessenen und differenzierten Funktions- und Interpretationswortschatz.</td><td contenteditable="true">${Math.ceil(teilAAusdrPoints * 0.238)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">4</td><td contenteditable="true">verwendet einen variablen und dem jeweiligen Zieltextformat angemessenen Satzbau.</td><td contenteditable="true">${Math.floor(teilAAusdrPoints * 0.333)}</td><td contenteditable="true"></td></tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true" colspan="2">Summe Ausdrucksverm√∂gen/Verf√ºgbarkeit sprachl. Mittel</td>
                                <td contenteditable="true">${teilAAusdrPoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="preview-subtitle">Sprachrichtigkeit</div>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">Nr.</th>
                                <th style="width: 65%">Anforderung</th>
                                <th style="width: 15%">Punkte</th>
                                <th style="width: 15%">Erreicht</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td contenteditable="true">1</td><td contenteditable="true">Wortschatz</td><td contenteditable="true">${Math.ceil(teilASprachPoints * 0.381)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">2</td><td contenteditable="true">Grammatik</td><td contenteditable="true">${Math.ceil(teilASprachPoints * 0.381)}</td><td contenteditable="true"></td></tr>
                            <tr><td contenteditable="true">3</td><td contenteditable="true">Orthographie (Rechtschreibung und Zeichensetzung)</td><td contenteditable="true">${Math.floor(teilASprachPoints * 0.238)}</td><td contenteditable="true"></td></tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true" colspan="2">Summe Sprachrichtigkeit</td>
                                <td contenteditable="true">${teilASprachPoints}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>

                    <p style="font-weight: bold; margin-top: 20px; font-size: 1.1em; color: #667eea;">
                        Summe Sprache Teil A: ${teilALanguagePoints} Punkte
                    </p>
                    <p style="font-weight: bold; margin-top: 10px; font-size: 1.2em; color: #333;">
                        Gesamtpunktzahl Teil A (Inhalt + Sprache): ${teilAInhalt + teilALanguagePoints} Punkte
                    </p>
                </div>
            `;

            if (hasMediation) {
                teilBTasks.forEach((teilaufgabe) => {
                    html += `
                        <div class="preview-section">
                            <div class="preview-title">${teilaufgabe.name}</div>
                            <div class="preview-subtitle">Typ: ${teilaufgabe.typ}</div>
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">Nr.</th>
                                        <th style="width: 65%">Anforderung</th>
                                        <th style="width: 15%">Punkte</th>
                                        <th style="width: 15%">Erreicht</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    teilaufgabe.kriterien.forEach(kriterium => {
                        html += `
                            <tr>
                                <td contenteditable="true">${kriterium.nr}</td>
                                <td contenteditable="true">${kriterium.text}</td>
                                <td contenteditable="true">${kriterium.punkte}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        `;
                    });

                    const summe = teilaufgabe.kriterien.reduce((sum, k) => sum + (typeof k.punkte === 'number' ? k.punkte : 0), 0);
                    teilBInhalt += summe;

                    html += `
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td contenteditable="true" colspan="2">Summe ${teilaufgabe.name}</td>
                                    <td contenteditable="true">${summe}</td>
                                    <td contenteditable="true"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    `;
                });

                html += `
                    <div class="preview-section">
                        <div class="preview-title">Teil B: Sprachliche Leistung / Darstellungsleistung</div>
                        <div class="preview-subtitle">Kommunikative Textgestaltung</div>
                        <table class="preview-table">
                            <thead><tr><th style="width: 5%">Nr.</th><th style="width: 65%">Anforderung</th><th style="width: 15%">Punkte</th><th style="width: 15%">Erreicht</th></tr></thead>
                            <tbody>
                                <tr><td contenteditable="true">1</td><td contenteditable="true">richtet seinen/ihren Text konsequent und explizit im Sinne der Aufgabenstellung auf die Intention und den/die Adressaten aus.</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">2</td><td contenteditable="true">beachtet die Textsortenmerkmale der jeweils geforderten Zieltextformate.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">3</td><td contenteditable="true">erstellt einen sachgerecht strukturierten leserfreundlichen Text.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">4</td><td contenteditable="true">formuliert hinreichend ausf√ºhrlich.</td><td contenteditable="true">1</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">5</td><td contenteditable="true">belegt seine Aussagen durch funktionale Verwendung von Verweisen und Zitaten.</td><td contenteditable="true">1</td><td contenteditable="true"></td></tr>
                                <tr style="background: #f0f0f0; font-weight: bold;"><td colspan="2">Summe Kommunikative Textgestaltung</td><td contenteditable="true">9</td><td contenteditable="true"></td></tr>
                            </tbody>
                        </table>
                        <div class="preview-subtitle">Ausdrucksverm√∂gen</div>
                        <table class="preview-table">
                            <thead><tr><th style="width: 5%">Nr.</th><th style="width: 65%">Anforderung</th><th style="width: 15%">Punkte</th><th style="width: 15%">Erreicht</th></tr></thead>
                            <tbody>
                                <tr><td contenteditable="true">1</td><td contenteditable="true">l√∂st sich vom Ausgangstext und formuliert eigenst√§ndig.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">2</td><td contenteditable="true">verwendet angemessenen Wortschatz.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">3</td><td contenteditable="true">verwendet Funktionswortschatz.</td><td contenteditable="true">2</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">4</td><td contenteditable="true">verwendet variablen Satzbau.</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr style="background: #f0f0f0; font-weight: bold;"><td colspan="2">Summe Ausdrucksverm√∂gen</td><td contenteditable="true">9</td><td contenteditable="true"></td></tr>
                            </tbody>
                        </table>
                        <div class="preview-subtitle">Sprachrichtigkeit</div>
                        <table class="preview-table">
                            <thead><tr><th style="width: 5%">Nr.</th><th style="width: 65%">Anforderung</th><th style="width: 15%">Punkte</th><th style="width: 15%">Erreicht</th></tr></thead>
                            <tbody>
                                <tr><td contenteditable="true">1</td><td contenteditable="true">Wortschatz</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">2</td><td contenteditable="true">Grammatik</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr><td contenteditable="true">3</td><td contenteditable="true">Orthographie</td><td contenteditable="true">3</td><td contenteditable="true"></td></tr>
                                <tr style="background: #f0f0f0; font-weight: bold;"><td colspan="2">Summe Sprachrichtigkeit</td><td contenteditable="true">9</td><td contenteditable="true"></td></tr>
                            </tbody>
                        </table>
                        <p style="font-weight: bold; margin-top: 20px; font-size: 1.1em; color: #667eea;">Summe Sprache Teil B: 27 Punkte</p>
                        <p style="font-weight: bold; margin-top: 10px; font-size: 1.2em; color: #333;">Gesamtpunktzahl Teil B (Inhalt + Sprache): ${teilBInhalt + 27} Punkte</p>
                    </div>
                `;
            }

            // Summary table
            html += `<div class="preview-section" style="margin-top: 30px;"><h2>Gesamt√ºbersicht</h2><table class="preview-table"><thead><tr><th style="width: 60%">Bereich</th><th style="width: 20%">Maximum</th><th style="width: 20%">Erreicht</th></tr></thead><tbody>`;

            if (currentListeningMode) {
                html += `<tr><td contenteditable="true">Listening Comprehension</td><td contenteditable="true">30</td><td contenteditable="true"></td></tr>`;
            }
            html += `<tr><td contenteditable="true">Gesamtpunktzahl Inhalt Teil A</td><td contenteditable="true">${teilAInhalt}</td><td contenteditable="true"></td></tr>`;
            html += `<tr><td contenteditable="true">Gesamtpunktzahl Sprache Teil A</td><td contenteditable="true">${teilALanguagePoints}</td><td contenteditable="true"></td></tr>`;

            if (hasMediation) {
                html += `<tr><td contenteditable="true">Gesamtpunktzahl Inhalt Teil B</td><td contenteditable="true">${teilBInhalt}</td><td contenteditable="true"></td></tr>`;
                html += `<tr><td contenteditable="true">Gesamtpunktzahl Sprache Teil B</td><td contenteditable="true">27</td><td contenteditable="true"></td></tr>`;
            }

            const listeningPoints = currentListeningMode ? 30 : 0;
            const gesamtMax = listeningPoints + teilAInhalt + teilALanguagePoints + (hasMediation ? teilBInhalt + 27 : 0);
            html += `<tr style="background: #f0f0f0; font-weight: bold;"><td contenteditable="true">GESAMT${hasMediation ? ' (Teil A + Teil B)' : ''}</td><td contenteditable="true">${gesamtMax} Punkte</td><td contenteditable="true"></td></tr></tbody></table></div>`;

            // Notenschl√ºssel
            const scale150Header = currentListeningMode ? '180 Punkte' : '150 Punkte';
            const scale150Values = currentListeningMode ? {95:'171-180',90:'162-170',85:'154-161',80:'144-153',75:'136-143',70:'126-135',65:'118-125',60:'108-117',55:'100-107',50:'90-99',45:'82-89',40:'72-81',33:'60-71',27:'49-59',20:'36-48',0:'0-35'} : {95:'143-150',90:'135-142',85:'128-134',80:'120-127',75:'113-119',70:'105-112',65:'98-104',60:'90-97',55:'83-89',50:'75-82',45:'68-74',40:'60-67',33:'50-59',27:'41-49',20:'30-40',0:'0-29'};

            html += `<div class="preview-section" style="page-break-before: always; margin-top: 40px;"><h2>Notenschl√ºssel</h2><table class="preview-table"><thead><tr><th>Anteil (ab)</th><th>${scale150Header}</th><th>160 Punkte</th><th>200 Punkte</th><th>Notenpunkte</th></tr></thead><tbody>`;
            const grades = [[95,15],[90,14],[85,13],[80,12],[75,11],[70,10],[65,9],[60,8],[55,7],[50,6],[45,5],[40,4],[33,3],[27,2],[20,1],[0,0]];
            const p160 = ['152-160','144-151','136-143','128-135','120-127','112-119','104-111','96-103','88-95','80-87','72-79','64-71','53-63','43-52','32-42','0-31'];
            const p200 = ['190-200','180-189','170-179','160-169','150-159','140-149','130-139','120-129','110-119','100-109','90-99','80-89','66-79','54-65','40-53','0-39'];
            grades.forEach(([pct, np], i) => {
                html += `<tr><td contenteditable="true">${pct}%</td><td contenteditable="true">${scale150Values[pct]}</td><td contenteditable="true">${p160[i]}</td><td contenteditable="true">${p200[i]}</td><td contenteditable="true" style="font-weight: bold;">${np}</td></tr>`;
            });
            html += `</tbody></table></div>`;

            outputDiv.innerHTML = html;
        }

        function printAsPdf() {
            if (!currentContentData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }
            window.print();
        }

        function copyToClipboard(event) {
            const outputDiv = document.getElementById('output');
            const text = outputDiv.innerText;

            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Kopiert!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Fehler beim Kopieren: ' + err);
            });
        }
    </script>

    <footer style="text-align: center; padding: 20px 0; color: rgba(255,255,255,0.5); font-size: 0.85em;">
        From Simon with love ‚ù§Ô∏è
    </footer>
</body>
</html>
