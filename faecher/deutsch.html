
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erwartungshorizont Generator - Deutsch</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="../shared/styles.css">
    <style>
        .aufgaben-preview {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .aufgabe-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .aufgabe-header {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }
        .teilaufgabe {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .teilaufgabe:last-child {
            border-bottom: none;
        }
        .punkte-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .erwartung-box {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .erwartung-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .bewertung-table {
            width: 100%;
            margin-top: 15px;
        }
        .bewertung-table th {
            background: rgba(102, 126, 234, 0.3);
        }
        /* Styles for lists inside tables */
        td ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: disc;
        }
        td li {
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="../images/schoollogoonly.png" alt="School Logo" class="header-logo">
                <h1>Erwartungshorizont Generator</h1>
            </div>
            <p>für Klausuren Sek II NRW</p>
        </div>

        <!-- Subject Tabs -->
        <div class="subject-tabs">
            <div class="subject-tabs-container">
                <a href="englisch.html" class="subject-tab">Englisch</a>
                <a href="philosophie.html" class="subject-tab">Philosophie</a>
                <a href="mathematik.html" class="subject-tab">Mathematik</a>
                <a href="deutsch.html" class="subject-tab active">Deutsch</a>
            </div>
        </div>

        <!-- Deutsch Content -->
        <div class="subject-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div class="glass-card">
                    <div class="info-box">
                        <h3>So funktioniert's:</h3>
                        <ul>
                            <li>Lade deine Deutsch-Klausur als PDF hoch (mit Aufgaben und Punkteverteilung)</li>
                            <li>Du erhältst einen Erwartungshorizont mit Bewertungskriterien</li>
                        </ul>
                        <p style="margin-top: 12px;">
                            WICHTIG: Das PDF muss textbasiert sein, nicht gescannt. Check: Kannst du Text im PDF markieren? Nur dann funktioniert der Generator.
                        </p>
                        <p style="margin-top: 8px;">
                            Der Generator kann Fehler machen: Bitte überprüfe alle Kriterien.
                        </p>
                    </div>

                    <div class="pdf-upload-section">
                        <label style="font-size: 1.05em; font-weight: 600; margin-bottom: 12px; display: block;">
                            Klausur-PDF hochladen (Pflicht)
                        </label>
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 15px;">
                            Lade die vollständige Klausur mit Text und Aufgabenstellungen hoch
                        </p>
                        <div id="pdfDropZone" class="pdf-drop-zone">
                            <div style="font-size: 3em; margin-bottom: 10px;">&#128221;</div>
                            <p style="color: white; font-weight: 500; margin-bottom: 5px;">Deutsch-Klausur PDF hier ablegen</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em;">oder klicken zum Auswählen</p>
                        </div>
                        <input type="file" id="pdfUpload" accept=".pdf" style="display: none;">
                        <button type="button" class="pdf-select-btn" onclick="document.getElementById('pdfUpload').click()">
                            Datei auswählen
                        </button>
                        <p id="pdfStatus" style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-top: 10px; display: none;"></p>
                    </div>

                    <div class="button-container">
                        <button class="generate-btn" id="generateBtn" onclick="generateErwartungshorizontDeutsch()" disabled>
                            Erwartungshorizont erstellen
                        </button>
                    </div>
                </div>

                <div class="glass-card-strong output-section">
                    <label>Generierter Erwartungshorizont:</label>
                    <div id="outputDeutsch" class="output empty">
                        Hier erscheint dein Erwartungshorizont...
                    </div>
                    <div class="download-buttons hidden" id="downloadButtonsDeutsch">
                        <button class="download-btn btn-pdf" onclick="printAsPdfDeutsch()">
                            Als PDF speichern
                        </button>
                        <button class="download-btn" onclick="copyToClipboardDeutsch()">
                            Kopieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDeutschData = null;
        let pdfBase64Data = null;

        // NRW Notenschluessel: Berechnet Punktebereiche basierend auf Gesamtpunktzahl
        function berechneNotenschluessel(gesamtpunkte) {
            const noten = [
                { note: 15, prozentMin: 95, prozentMax: 100 },
                { note: 14, prozentMin: 90, prozentMax: 94 },
                { note: 13, prozentMin: 85, prozentMax: 89 },
                { note: 12, prozentMin: 80, prozentMax: 84 },
                { note: 11, prozentMin: 75, prozentMax: 79 },
                { note: 10, prozentMin: 70, prozentMax: 74 },
                { note: 9, prozentMin: 65, prozentMax: 69 },
                { note: 8, prozentMin: 60, prozentMax: 64 },
                { note: 7, prozentMin: 55, prozentMax: 59 },
                { note: 6, prozentMin: 50, prozentMax: 54 },
                { note: 5, prozentMin: 45, prozentMax: 49 },
                { note: 4, prozentMin: 40, prozentMax: 44 },
                { note: 3, prozentMin: 33, prozentMax: 39 },
                { note: 2, prozentMin: 27, prozentMax: 32 },
                { note: 1, prozentMin: 20, prozentMax: 26 },
                { note: 0, prozentMin: 0, prozentMax: 19 }
            ];

            return noten.map(n => {
                const punkteMin = Math.ceil(gesamtpunkte * n.prozentMin / 100);
                const punkteMax = n.prozentMax === 100
                    ? gesamtpunkte
                    : Math.floor(gesamtpunkte * n.prozentMax / 100);

                const prozentText = n.note === 15
                    ? `>= ${n.prozentMin}%`
                    : `${n.prozentMin}% - ${n.prozentMax}%`;

                const bereichText = n.note === 15
                    ? `${punkteMin} - ${punkteMax}`
                    : `${punkteMin} - ${punkteMax}`;

                return {
                    note: n.note,
                    prozent: prozentText,
                    bereich: bereichText
                };
            });
        }

        // PDF upload handler for Deutsch
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('pdfUpload');
            const dropZone = document.getElementById('pdfDropZone');
            const statusEl = document.getElementById('pdfStatus');

            if (!fileInput || !dropZone || !statusEl) {
                console.error('Missing elements:', { fileInput, dropZone, statusEl });
                return;
            }

            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFile(files[0]);
                }
            });

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            const statusEl = document.getElementById('pdfStatus');
            const generateBtn = document.getElementById('generateBtn');
            const outputDiv = document.getElementById('outputDeutsch');
            const downloadButtons = document.getElementById('downloadButtonsDeutsch');

            // WICHTIG: Reset bei neuem Upload
            pdfBase64Data = null;
            currentDeutschData = null;
            outputDiv.className = 'output empty';
            outputDiv.innerHTML = 'Hier erscheint dein Erwartungshorizont...';
            downloadButtons.classList.add('hidden');

            statusEl.style.display = 'block';
            statusEl.textContent = 'PDF wird geladen...';
            statusEl.style.color = '#ffd700';

            try {
                // Convert PDF to Base64 for Gemini Vision
                const arrayBuffer = await file.arrayBuffer();

                // Check file size (max ~20MB for Gemini)
                if (arrayBuffer.byteLength > 20 * 1024 * 1024) {
                    statusEl.innerHTML = '<strong>PDF zu gross!</strong> Maximum: 20 MB';
                    statusEl.style.color = '#ff6b6b';
                    generateBtn.disabled = true;
                    return;
                }

                // Convert to Base64
                const bytes = new Uint8Array(arrayBuffer);
                let binary = '';
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                pdfBase64Data = btoa(binary);

                const fileSizeMB = (arrayBuffer.byteLength / (1024 * 1024)).toFixed(2);
                statusEl.innerHTML = `PDF geladen (${fileSizeMB} MB) - Klicke auf "Erwartungshorizont erstellen"`;
                statusEl.style.color = '#4caf50';
                generateBtn.disabled = false;

            } catch (error) {
                console.error('PDF Read Error:', error);
                statusEl.textContent = 'Fehler beim Lesen der PDF: ' + error.message;
                statusEl.style.color = '#ff6b6b';
                generateBtn.disabled = true;
            }
        }

        async function generateErwartungshorizontDeutsch() {
            if (!pdfBase64Data) {
                alert('Bitte zuerst eine Klausur-PDF hochladen!');
                return;
            }

            const outputDiv = document.getElementById('outputDeutsch');
            const generateBtn = document.getElementById('generateBtn');
            const downloadButtons = document.getElementById('downloadButtonsDeutsch');

            generateBtn.disabled = true;
            generateBtn.textContent = 'Wird generiert...';
            outputDiv.className = 'output loading';
            outputDiv.innerHTML = 'Klausur wird analysiert...<br><small>Gemini liest den Text und die Aufgaben aus der PDF.</small>';
            downloadButtons.classList.add('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: 'deutsch',
                        pdfBase64: pdfBase64Data,
                        timestamp: Date.now()
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Fehler bei der Generierung');
                }

                const data = await response.json();

                if (data.success) {
                    currentDeutschData = data.data;
                    renderDeutschOutput(data.data);
                    downloadButtons.classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }

            } catch (error) {
                console.error('Generation Error:', error);
                outputDiv.className = 'output';
                outputDiv.innerHTML = `<p style="color: #d32f2f;">Fehler: ${error.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Erwartungshorizont erstellen';
            }
        }

        function renderDeutschOutput(data) {
            const outputDiv = document.getElementById('outputDeutsch');
            outputDiv.className = 'output';

            let html = `
                <div class="preview-section">
                    <h2>Erwartungshorizont Deutsch</h2>
                    <p style="margin-bottom: 20px;">
                        <strong>Stufe:</strong> ${data.klausurInfo?.stufe || 'Q2'} |
                        <strong>Kursart:</strong> ${data.klausurInfo?.kursart || 'GK'} |
                        <strong>Klausurtyp:</strong> ${data.klausurInfo?.klausurtyp || 'Textanalyse'} |
                        <strong>Gesamtpunkte:</strong> ${data.klausurInfo?.gesamtpunkte || 100}
                    </p>
            `;

            html += '<h3 class="preview-subtitle">Inhaltliche Leistung</h3>';

            // Render each Aufgabe
            let inhaltsPunkte = 0;
            if (data.aufgaben) {
                data.aufgaben.forEach(aufgabe => {
                    html += `
                        <div class="preview-section" style="margin-top: 20px;">
                            <h4 style="color: #667eea;">Aufgabe ${aufgabe.nummer}: ${aufgabe.titel || ''}</h4>
                    `;

                    if (aufgabe.teilaufgaben) {
                        aufgabe.teilaufgaben.forEach(ta => {
                            html += `
                                <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <h5>${ta.bezeichnung}) <span class="punkte-badge">${ta.punkte} Punkte</span></h5>
                            `;

                            // Erwartung
                            if (ta.erwartung) {
                                html += `<div class="erwartung-box">
                                    <h4>Erwartete Leistung:</h4>
                                    <p>${ta.erwartung}</p>
                                </div>`;
                            }

                            // Bewertungskriterien
                            if (ta.bewertung && ta.bewertung.length > 0) {
                                html += `
                                    <table class="preview-table bewertung-table">
                                        <thead><tr>
                                            <th style="width: 70%;">Anforderung</th>
                                            <th style="width: 15%;">Max.</th>
                                            <th style="width: 15%;">Erreicht</th>
                                        </tr></thead><tbody>`;

                                ta.bewertung.forEach((bew, index) => {
                                    const anfText = bew.anf || bew.anforderung || '';
                                    const anfPunkte = bew.p || bew.punkte || 0;
                                    inhaltsPunkte += anfPunkte;

                                    // Check if this is the last item (erfuellt ein weiteres)
                                    const isLastItem = index === ta.bewertung.length - 1;
                                    const isErfuelltEinWeiteres = anfText.includes('erfüllt ein weiteres aufgabenbezogenes Kriterium');

                                    // For Aufgabe 2: Show italic disclaimer BEFORE the last item
                                    if (aufgabe.nummer === 2 && isLastItem && index > 0) {
                                        html += `<tr style="background: rgba(255,255,255,0.02);">
                                            <td contenteditable="true" colspan="3" style="font-style: italic; padding: 12px;">
                                                Angestrebt ist hier keine vollständige Darstellung der beispielhaft genannten Aspekte, sondern eine differenzierte Schwerpunktsetzung durch den Prüfling, die allerdings mehrere Gesichtspunkte aufgreift.
                                            </td>
                                        </tr>`;
                                    }

                                    // Show points in brackets for "erfuellt ein weiteres"
                                    const punkteDisplay = isErfuelltEinWeiteres ? `(${anfPunkte})` : anfPunkte;

                                    html += `<tr>
                                        <td contenteditable="true">${anfText}</td>
                                        <td contenteditable="true">${punkteDisplay}</td>
                                        <td contenteditable="true"></td>
                                    </tr>`;
                                });

                                html += `<tr style="font-weight: bold; background: rgba(102, 126, 234, 0.1);">
                                    <td contenteditable="true">Gesamtpunktzahl für die Aufgabe</td>
                                    <td contenteditable="true">${ta.punkte}</td>
                                    <td contenteditable="true"></td>
                                </tr></tbody></table>`;
                            }

                            html += `</div>`;
                        });
                    }

                    html += `</div>`;
                });
            }

            // Darstellungsleistung (EXAKER WORDLAUT)
            html += `
                <div class="preview-section" style="margin-top: 30px;">
                    <h3 class="preview-subtitle">Darstellungsleistung (28 Punkte)</h3>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 65%;">Anforderungen</th>
                                <th style="width: 15%;">maximal<br>erreichbare<br>Punktzahl</th>
                                <th style="width: 20%;">Der Prüfling</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">
                                    <strong>1 strukturiert seinen Text kohärent, schlüssig, stringent und gedanklich klar:</strong>
                                    <ul>
                                        <li>angemessene Gewichtung der Teilaufgaben in der Durchführung,</li>
                                        <li>gegliederte und angemessen gewichtete Anlage der Arbeit,</li>
                                        <li>schlüssige Verbindung der einzelnen Arbeitsschritte,</li>
                                        <li>schlüssige gedankliche Verknüpfung von Sätzen.</li>
                                    </ul>
                                </td>
                                <td contenteditable="true">6</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">
                                    <strong>2 formuliert unter Beachtung der fachsprachlichen und fachmethodischen Anforderungen:</strong>
                                    <ul>
                                        <li>Trennung von Handlungs- und Metaebene,</li>
                                        <li>begründeter Bezug von beschreibenden, deutenden und wertenden Aussagen,</li>
                                        <li>Verwendung von Fachtermini in sinnvollem Zusammenhang,</li>
                                        <li>Beachtung der Tempora,</li>
                                        <li>korrekte Redewiedergabe (Modalität).</li>
                                    </ul>
                                </td>
                                <td contenteditable="true">6</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">
                                    <strong>3 belegt Aussagen durch angemessenes und korrektes Zitieren:</strong>
                                    <ul>
                                        <li>sinnvoller Gebrauch von vollständigen oder gekürzten Zitaten in begründender Funktion.</li>
                                    </ul>
                                </td>
                                <td contenteditable="true">3</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">
                                    <strong>4 drückt sich allgemeinsprachlich präzise, stilistisch sicher und begrifflich differenziert aus:</strong>
                                    <ul>
                                        <li>sachlich-distanzierte Schreibweise,</li>
                                        <li>Schriftsprachlichkeit,</li>
                                        <li>begrifflich abstrakte Ausdrucksfähigkeit.</li>
                                    </ul>
                                </td>
                                <td contenteditable="true">5</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">
                                    <strong>5 formuliert lexikalisch und syntaktisch sicher, variabel und komplex (und zugleich klar).</strong>
                                </td>
                                <td contenteditable="true">5</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">
                                    <strong>6 schreibt sprachlich richtig.</strong>
                                </td>
                                <td contenteditable="true">3</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td>Summe Darstellungsleistung</td>
                                <td>28</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Gesamtuebersicht: Calculate actual points from Aufgabe 1 + Aufgabe 2 + Darstellungsleistung (28)
            const darstellungPunkte = 28;
            const gesamtpunkte = inhaltsPunkte + darstellungPunkte;

            html += `
                <div class="preview-section" style="margin-top: 40px;">
                    <h3 class="preview-subtitle">Gesamtuebersicht</h3>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Bereich</th>
                                <th>Max. Punkte</th>
                                <th>Erreichte Punkte</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">Inhaltliche Leistung</td>
                                <td contenteditable="true">${inhaltsPunkte}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr>
                                <td contenteditable="true">Darstellungsleistung</td>
                                <td contenteditable="true">${darstellungPunkte}</td>
                                <td contenteditable="true"></td>
                            </tr>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td contenteditable="true">GESAMT</td>
                                <td contenteditable="true">${gesamtpunkte}</td>
                                <td contenteditable="true"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Notenschluessel
            const notentabelle = berechneNotenschluessel(gesamtpunkte);

            html += `
                <div class="preview-section" style="page-break-before: always; margin-top: 40px;">
                    <h3 class="preview-subtitle">Notenschluessel (${gesamtpunkte} Punkte)</h3>
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Notenpunkte</th>
                                <th>Prozent</th>
                                <th>Punktebereich</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${notentabelle.map(n => `
                                <tr>
                                    <td contenteditable="true" style="font-weight: bold;">${n.note}</td>
                                    <td contenteditable="true">${n.prozent}</td>
                                    <td contenteditable="true">${n.bereich}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            html += `</div>`;
            outputDiv.innerHTML = html;
        }

        function copyToClipboardDeutsch(event) {
            const outputDiv = document.getElementById('outputDeutsch');
            const text = outputDiv.innerText;

            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Kopiert!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Fehler beim Kopieren: ' + err);
            });
        }

        function printAsPdfDeutsch() {
            if (!currentDeutschData) {
                alert('Bitte erst einen Erwartungshorizont erstellen!');
                return;
            }
            window.print();
        }

    </script>

    <footer style="text-align: center; padding: 20px 0; color: rgba(255,255,255,0.5); font-size: 0.85em;">
        From Simon with love ❤️
    </footer>
</body>
</html>
